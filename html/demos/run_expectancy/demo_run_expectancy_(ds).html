<!DOCTYPE html>
<html>
  <head><meta charset="utf-8" />

    
    

    <title></title><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.0/dist/bootstrap-toc.min.js"></script>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.0/dist/bootstrap-toc.min.css">  
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css">
    <link rel="stylesheet" href="/LS88/assets/css/style.css">
    <link rel="stylesheet" href="/LS88/assets/css/table.css">
    <link rel="stylesheet" href="/LS88/assets/css/ipy_base.css">
    <link rel="stylesheet" href="/LS88/assets/css/ipy_nb.css">
    <link rel="stylesheet" href="/LS88/assets/css/ipy_tree.css">
    <link rel="stylesheet" href="/LS88/assets/css/ipy_syntax.css">


    <!-- Loading mathjax macro -->
    <!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    <!-- End of mathjax configuration --></head>
    <body>
      
      <!--Navigation bar-->
      
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
	<a class="navbar-brand" href="/LS88/index.html">LS88 - Sports Analytics</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
	<span class="navbar-toggler-icon"></span>
	</button>
	<div class="collapse navbar-collapse" id="navbarSupportedContent">
		<ul class="navbar-nav mr-auto">
			<li class="nav-item">
				<a class="nav-link" href="/LS88/syllabus.html">Syllabus</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/LS88/demos.html">Demos</a>
			</li>
			<!-- <li class="nav-item dropdown">
				<a class="nav-link dropdown-toggle" data-toggle="dropdown">HW</a>
				<div class="dropdown-menu">
					<a class="dropdown-item" href="#">Data8 Review</a>
					<a class="dropdown-item" href="#">Baseball Statistics</a>
					<a class="dropdown-item" href="#">4th Down Bot</a>
				</div>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/LS88/lectures.html">Lectures</a>
			</li> -->
		</ul>
	</div>
</nav>
      <!--end of Navigation bar-->
      
      <div id="bodyContent">
        <div class="container" id="main-container">
          <div class="row">
            <div class="col-2">
                <nav id="toc" data-toggle="toc" class="sticky-top"></nav>
            </div>
            <div class="col-10">
              <div tabindex="-1" id="notebook" class="border-box-sizing">
                <div class="container" id="notebook-container" data-spy="scroll" data-target="#toc">
                  
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Demo---Run-Expectancy">Demo - Run Expectancy<a class="anchor-link" href="#Demo---Run-Expectancy">&#182;</a></h1><p>This demo explores the concept of run expectancy and the <em>Run Expectancy Matrix</em>, an empirically driven measurement of how many runs we should expect to score in a given out/baserunner state.  We use run expectancy to explore basic baseball strategies like bunting and stealing.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">run</span> ../../utils/notebook_setup.py
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Adding datascience helper tools to path...
Setting up Matplotlib...
</pre>
</div>
</div>

<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Matplotlib imported as mpl
Matplotlib.pyplot imported as plt
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">datascience</span> <span class="k">import</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># custom functions that will help do some simple tasks</span>
<span class="kn">from</span> <span class="nn">datascience_utils</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">datascience_stats</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">datascience_topic</span> <span class="k">import</span> <span class="n">fast_run_expectancy</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Run-Expectancy">Run Expectancy<a class="anchor-link" href="#Run-Expectancy">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-Play-by-Play-Data-from-Retrosheet">Load Play-by-Play Data from Retrosheet<a class="anchor-link" href="#Load-Play-by-Play-Data-from-Retrosheet">&#182;</a></h3><p>Raw Retrosheet data (<a href="http://www.retrosheet.org/">http://www.retrosheet.org/</a>) contains play-by-play event logs, representing very raw information about the events in a baseball game. Lucky for us, the software program Chadwick (found here:<a href="http://chadwick.sourceforge.net/doc/index.html">http://chadwick.sourceforge.net/doc/index.html</a>) was created to handle a lot of the messy work to compiled the data into a useable form.  Chadwick converts the raw logs into CSV which is what we use here.  Also, Chadwick computes some pretty important quantities that we make use of.</p>
<p>Note: This notebook uses data from 2001.  We could have used more recent data but Barry Bonds is a baseball god so part of this notebook is an excuse to revel in his statistical absurdity.</p>
<p>For computing the Run Expectancy Matrix as well as other analsis, we only need a few columns.  The relevant columns are:</p>
<ul>
<li>EVENT_ID - An ID for the event in the dataset</li>
<li>INN_CT - Inning number</li>
<li>EVENT_CD - A code for what happened in the event</li>
<li>OUTS_CT - Number of outs</li>
<li>BAT_LINEUP_ID - Place in the batting order.  1 through 9.</li>
<li>BAT_EVENT_FL - A T/F flag as to whether the play-by-play event corresponds to a plate appearance (T) or some other type of event (F).</li>
<li>START_BASES_CD - An integer code representing the state of the runners, eg. runner on 2nd</li>
<li>END_BASES_CD - An integer code representing the state of the runners AFTER the event ends.</li>
<li>EVENT_OUTS_CT - Number of outs recorded on this event</li>
<li>EVENT_RUNS_CT - Number of runs scored on this event</li>
<li>FATE_RUNS_CT - Number of runs scored AFTER this event</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EVENT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;INN_CT&#39;</span><span class="p">,</span> <span class="s1">&#39;EVENT_CD&#39;</span><span class="p">,</span> <span class="s1">&#39;OUTS_CT&#39;</span><span class="p">,</span> <span class="s1">&#39;BAT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;BAT_LINEUP_ID&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BAT_EVENT_FL&#39;</span><span class="p">,</span> <span class="s1">&#39;START_BASES_CD&#39;</span><span class="p">,</span> <span class="s1">&#39;END_BASES_CD&#39;</span><span class="p">,</span> <span class="s1">&#39;EVENT_OUTS_CT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;EVENT_RUNS_CT&#39;</span><span class="p">,</span> <span class="s1">&#39;FATE_RUNS_CT&#39;</span><span class="p">]</span>
<span class="n">retro</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s1">&#39;retrosheet_events-2001.csv.gz&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

<span class="n">new_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Inning&#39;</span><span class="p">,</span> <span class="s1">&#39;Event_Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Outs&#39;</span><span class="p">,</span> <span class="s1">&#39;Batter_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Lineup_Order&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PA_Flag&#39;</span><span class="p">,</span> <span class="s1">&#39;Start_Bases&#39;</span><span class="p">,</span> <span class="s1">&#39;End_Bases&#39;</span><span class="p">,</span> <span class="s1">&#39;Event_Outs&#39;</span><span class="p">,</span> <span class="s1">&#39;Event_Runs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Future_Runs&#39;</span><span class="p">]</span>
<span class="n">retro</span><span class="o">.</span><span class="n">relabel</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">new_cols</span><span class="p">)</span>

<span class="n">retro</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>Inning</th> <th>Outs</th> <th>Batter_ID</th> <th>Lineup_Order</th> <th>Event_Type</th> <th>PA_Flag</th> <th>Event_Outs</th> <th>ID</th> <th>Start_Bases</th> <th>End_Bases</th> <th>Event_Runs</th> <th>Future_Runs</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1     </td> <td>0   </td> <td>greer001 </td> <td>1           </td> <td>2         </td> <td>T      </td> <td>1         </td> <td>1   </td> <td>0          </td> <td>0        </td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>1   </td> <td>velar001 </td> <td>2           </td> <td>2         </td> <td>T      </td> <td>1         </td> <td>2   </td> <td>0          </td> <td>0        </td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>2   </td> <td>rodra001 </td> <td>3           </td> <td>2         </td> <td>T      </td> <td>1         </td> <td>3   </td> <td>0          </td> <td>0        </td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>0   </td> <td>erstd001 </td> <td>1           </td> <td>20        </td> <td>T      </td> <td>0         </td> <td>4   </td> <td>0          </td> <td>1        </td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>0   </td> <td>ecksd001 </td> <td>2           </td> <td>20        </td> <td>T      </td> <td>0         </td> <td>5   </td> <td>1          </td> <td>3        </td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>0   </td> <td>salmt001 </td> <td>3           </td> <td>3         </td> <td>T      </td> <td>2         </td> <td>6   </td> <td>3          </td> <td>4        </td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>2   </td> <td>glaut001 </td> <td>4           </td> <td>14        </td> <td>T      </td> <td>0         </td> <td>7   </td> <td>4          </td> <td>5        </td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>2   </td> <td>andeg001 </td> <td>5           </td> <td>2         </td> <td>T      </td> <td>1         </td> <td>8   </td> <td>5          </td> <td>5        </td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>2     </td> <td>0   </td> <td>palmr001 </td> <td>4           </td> <td>14        </td> <td>T      </td> <td>0         </td> <td>9   </td> <td>0          </td> <td>1        </td> <td>0         </td> <td>4          </td>
        </tr>
    </tbody>
        <tr>
            <td>2     </td> <td>0   </td> <td>rodri001 </td> <td>5           </td> <td>2         </td> <td>T      </td> <td>1         </td> <td>10  </td> <td>1          </td> <td>1        </td> <td>0         </td> <td>4          </td>
        </tr>
    </tbody>
</table>
<p>... (193348 rows omitted)</p
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The play-by-play data contains entries that are not plate appearances.  One example is balks.  We want to drop these entries because they are not relevant to the question we are trying to answer.</p>
<p>We also want to drop all data from the ninth inning or later.  This is because we want data that represents the regular course of play.  We hypothesize these end of game events violate some of our assumptions about the regular strategic play, or even are truncated due to walk-off events.</p>
<p>These changes are not hugely impactful (for example, there are not that many non-batting events) but in the interest of completeness and proper data analysis, we perform this cleaning.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bat_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">retro</span><span class="p">[</span><span class="s1">&#39;PA_Flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">)</span>
<span class="n">retro</span> <span class="o">=</span> <span class="n">retro</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bat_mask</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">inning_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">retro</span><span class="p">[</span><span class="s1">&#39;Inning&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">retro</span> <span class="o">=</span> <span class="n">retro</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inning_mask</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Another thing we want to do is convert the integer codes for baserunner situations into recognizable strings.  This information is available from <a href="http://www.retrosheet.org/">http://www.retrosheet.org/</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">base_runner_codes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;None on&quot;</span><span class="p">,</span>  <span class="c1"># No one on</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;1st&quot;</span><span class="p">,</span>  <span class="c1"># runner on 1st</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;2nd&quot;</span><span class="p">,</span>  <span class="c1"># runner on 2nd</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;1st and 2nd&quot;</span><span class="p">,</span>  <span class="c1"># runners on 1st &amp; 2nd</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;3rd&quot;</span><span class="p">,</span>  <span class="c1"># runner on 3rd</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;1st and 3rd&quot;</span><span class="p">,</span>  <span class="c1"># runners on 1st &amp; 3rd</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;2nd and 3rd&quot;</span><span class="p">,</span>  <span class="c1"># runners on 2nd &amp; 3rd</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s2">&quot;Bases Loaded&quot;</span>  <span class="c1"># bases loaded</span>
<span class="p">}</span>
<span class="c1"># Replace the numeric code with a string code</span>
<span class="n">retro</span><span class="p">[</span><span class="s1">&#39;Start_Bases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">retro</span><span class="p">,</span> <span class="s1">&#39;Start_Bases&#39;</span><span class="p">,</span> <span class="n">base_runner_codes</span><span class="p">)</span>
<span class="n">retro</span><span class="p">[</span><span class="s1">&#39;End_Bases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">retro</span><span class="p">,</span> <span class="s1">&#39;End_Bases&#39;</span><span class="p">,</span> <span class="n">base_runner_codes</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">event_codes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;Generic out&#39;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span>  <span class="c1"># Strikeout</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;SB&#39;</span><span class="p">,</span>  <span class="c1"># Stolen Base</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;Defensive indifference&#39;</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;CS&#39;</span><span class="p">,</span>  <span class="c1"># Caught stealing</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;Pickoff error&#39;</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;Pickoff&#39;</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;Wild pitch&#39;</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;Passed ball&#39;</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;Balk&#39;</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;Other advance/out advancing&#39;</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">:</span> <span class="s1">&#39;Foul error&#39;</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">:</span> <span class="s1">&#39;BB&#39;</span><span class="p">,</span>  <span class="c1"># Walk</span>
    <span class="mi">15</span><span class="p">:</span> <span class="s1">&#39;IBB&#39;</span><span class="p">,</span>  <span class="c1"># Intentional walk</span>
    <span class="mi">16</span><span class="p">:</span> <span class="s1">&#39;HBP&#39;</span><span class="p">,</span>  <span class="c1"># Hit by pitch</span>
    <span class="mi">17</span><span class="p">:</span> <span class="s1">&#39;Interference&#39;</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">:</span> <span class="s1">&#39;RBOE&#39;</span><span class="p">,</span>  <span class="c1"># Reached base on error</span>
    <span class="mi">19</span><span class="p">:</span> <span class="s1">&#39;FC&#39;</span><span class="p">,</span>  <span class="c1"># Fielder&#39;s choice</span>
    <span class="mi">20</span><span class="p">:</span> <span class="s1">&#39;1B&#39;</span><span class="p">,</span>  <span class="c1"># Single</span>
    <span class="mi">21</span><span class="p">:</span> <span class="s1">&#39;2B&#39;</span><span class="p">,</span>  <span class="c1"># Double</span>
    <span class="mi">22</span><span class="p">:</span> <span class="s1">&#39;3B&#39;</span><span class="p">,</span>  <span class="c1"># Triple</span>
    <span class="mi">23</span><span class="p">:</span> <span class="s1">&#39;HR&#39;</span><span class="p">,</span>  <span class="c1"># Home run</span>
    <span class="mi">24</span><span class="p">:</span> <span class="s1">&#39;Missing play&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Replace numeric code with string</span>
<span class="n">retro</span><span class="p">[</span><span class="s1">&#39;Event_Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">retro</span><span class="p">,</span> <span class="s1">&#39;Event_Type&#39;</span><span class="p">,</span> <span class="n">event_codes</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Runs-in-Remainder-of-Inning">Runs in Remainder of Inning<a class="anchor-link" href="#Runs-in-Remainder-of-Inning">&#182;</a></h3><p>In order to compute the Run Expectancy Matrix, we need to just add <code>Future_Runs</code> and <code>Event_Runs</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">retro</span><span class="p">[</span><span class="s1">&#39;Runs_ROI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">retro</span><span class="p">[</span><span class="s1">&#39;Future_Runs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">retro</span><span class="p">[</span><span class="s1">&#39;Event_Runs&#39;</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Run-Expectancy-Matrix">Run Expectancy Matrix<a class="anchor-link" href="#Run-Expectancy-Matrix">&#182;</a></h3><p>The Run Expectancy Matrix is computed by grouping by <code>Outs</code> and <code>Bases</code> and computing an average.  For each out and baserunner combination, this collects all plate appearances in our dataset and the runs scored in the remainder of the inning from that plate appearance and after.  We are left with the 24 values that comprise the Run Expectancy Matrix.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">re</span> <span class="o">=</span> <span class="n">retro</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;Outs&#39;</span><span class="p">,</span> <span class="s1">&#39;Start_Bases&#39;</span><span class="p">,</span> <span class="s1">&#39;Runs_ROI&#39;</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">group</span><span class="p">([</span><span class="s1">&#39;Outs&#39;</span><span class="p">,</span> <span class="s1">&#39;Start_Bases&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
<span class="n">re</span><span class="o">.</span><span class="n">relabel</span><span class="p">(</span><span class="s1">&#39;Runs_ROI mean&#39;</span><span class="p">,</span> <span class="s1">&#39;RE&#39;</span><span class="p">)</span>
<span class="n">re</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;Outs&#39;</span><span class="p">,</span> <span class="s1">&#39;Start_Bases&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;RE&#39;</span><span class="p">,</span> <span class="n">collect</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">sort</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[8]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>Start_Bases</th> <th>0</th> <th>1</th> <th>2</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>None on     </td> <td>0.544516</td> <td>0.291897</td> <td>0.118223</td>
        </tr>
    </tbody>
        <tr>
            <td>1st         </td> <td>0.93984 </td> <td>0.56    </td> <td>0.247078</td>
        </tr>
    </tbody>
        <tr>
            <td>2nd         </td> <td>1.18258 </td> <td>0.717691</td> <td>0.354284</td>
        </tr>
    </tbody>
        <tr>
            <td>3rd         </td> <td>1.5374  </td> <td>0.993593</td> <td>0.36757 </td>
        </tr>
    </tbody>
        <tr>
            <td>1st and 2nd </td> <td>1.55191 </td> <td>0.915735</td> <td>0.435132</td>
        </tr>
    </tbody>
        <tr>
            <td>1st and 3rd </td> <td>1.86905 </td> <td>1.28487 </td> <td>0.508051</td>
        </tr>
    </tbody>
        <tr>
            <td>2nd and 3rd </td> <td>2.07769 </td> <td>1.43329 </td> <td>0.595846</td>
        </tr>
    </tbody>
        <tr>
            <td>Bases Loaded</td> <td>2.39332 </td> <td>1.60661 </td> <td>0.792754</td>
        </tr>
    </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>Questions</em></p>
<ol>
<li>What does the Run Expectancy Matrix describe about the nature of baseball?  </li>
<li>What can you observe about the difference between having a runner on second base vs third base (consider 2nd vs 3rd and 1st and 2nd vs 1st and 3rd)?  </li>
<li>How do things change with 2 outs?</li>
<li>What does run expectancy tell us generally about outs?  That is, how valuable is one extra base compared to an out?</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="On-Your-Own:-Evaluating-Strategies">On Your Own: Evaluating Strategies<a class="anchor-link" href="#On-Your-Own:-Evaluating-Strategies">&#182;</a></h3><h4 id="Stealing-Bases">Stealing Bases<a class="anchor-link" href="#Stealing-Bases">&#182;</a></h4><p>We can perform a simple analysis of the strategy of stealing bases by computing a success rate for a base stealer that makes the run expectancy of the steal attempt equivalent to the run expectancy of the current state.</p>
<p>The current state has run expectancy $\mathit{RE}_{\text{Current}}$ while the steal attempt has run expectancy of
$$
    \text{RE}_{\text{Steal Attempt}} = \mathit{RE}_{\text{SB}} \cdot p_{\text{SB}} + 
        \mathit{RE}_{\text{CS}} \cdot (1 - p_{\text{SB}}) 
$$
Equating $\mathit{RE}_{\text{Current}} = \text{RE}_{\text{Steal Attempt}}$ gives the equalizing probability
$$
    p_{\text{SB}} = \frac{\mathit{RE}_{\text{Current}} - \mathit{RE}_{\text{CS}}}{\mathit{RE}_{\text{SB}} - \mathit{RE}_{\text{CS}}}
$$</p>
<p>To do:</p>
<ul>
<li>A helper function has been provided where you put in the RE matrix and an out value and baserunner situation and it will give you the RE value.</li>
<li>Write a function to compute $p_{\text{SB}}$.  The function should take these inputs:<ul>
<li>RE table (the non-pivoted version)</li>
<li>Starting baserunner situation</li>
<li>Caught stealing baserunner situation</li>
<li>Stolen base baserunner situation.</li>
</ul>
</li>
<li>Consider three baserunner situations: "1st", "2nd", and "1st and 2nd" (ie. a double steal). Compute the success probability for each of the baserunner situations with varying out situations.  In the case of the double steal, we consider the natural case where the lead runner is thrown out.  </li>
<li>For each baserunner situation, iterate over the number of outs and print the results using this string:<br>
<code>f"Outs: {outs}  P(SB): {p:.3f}"</code></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_matrix_val</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">outs</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">to_array</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">outs</span> <span class="o">==</span> <span class="n">o</span> <span class="ow">and</span> <span class="n">base</span> <span class="o">==</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>Questions</em></p>
<ol>
<li>At about what success probability do most situations balance out?</li>
<li>What about for the double steal?  What does this analysis suggest about the risk-reward of a double steal?</li>
<li>What about with a runner at second with 2 outs?  Does this make sense based on how you understand the baseball run scoring process?</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Bunting">Bunting<a class="anchor-link" href="#Bunting">&#182;</a></h4><p>For bunting, we take a simpler view.  Assume we can execute the bunt strategy 100% of the time with a regular hitter (ie. not a pitcher at the plate).  Should we use this strategy?</p>
<p>To do:</p>
<ul>
<li>Write a function that prints a string comparing the run expectancy for various baserunner and out situations.  Use the string <code>f"Outs: {outs} RE_curr: {val_curr:.3f} RE_bunt: {val_bunt:.3f}"</code> to print out the results.  The function should take as inputs:<ul>
<li>RE table (the non-pivoted version)</li>
<li>Starting baserunner situation</li>
<li>Ending baserunner situation following successful bunt</li>
</ul>
</li>
<li>Consider the three baserunner situations: "1st", "2nd", and "1st and 2nd". Compute the 4 values for each of the baserunner situations with varying out situations.    For each baserunner situation, iterate over the number of outs and print the results.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>Questions</em></p>
<ol>
<li>What does run expectancy say about whether you should bunt?  What does this tell us about the value of an out?</li>
<li>What if we consider pitchers?  Does this analysis make sense?</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="On-Your-Own:-End-of-Game-Stealing/Bunting">On Your Own: End of Game Stealing/Bunting<a class="anchor-link" href="#On-Your-Own:-End-of-Game-Stealing/Bunting">&#182;</a></h3><p>Let's consider bunts or steals in the context of an end-of-game strategy.  Let's say we are the home team batting in the last half of the ninth inning (or later) and the game is tied.  We get a runner on base.  Should we bunt or steal?</p>
<p>In this situation we are no longer interested in expected runs but rather win probability.  And in this case, our probability of winning is just the probability of scoring more than one run.  We can compute a run/win probability matrix instead of a run expectancy matrix and use that to analyze the strategies.</p>
<p>To do:</p>
<ul>
<li>Compute the win probability matrix but instead of using <code>np.mean</code> like we did with the table <code>re</code>, use a function that will compute
$$
  \text{Probability of at least 1 run}
<pre><code>  = \frac{\text{# of times scoring $\geq$ 1 run}}
          {\text{Total number of observations}}
</code></pre>
$$</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="End-of-Game-Stealing">End of Game Stealing<a class="anchor-link" href="#End-of-Game-Stealing">&#182;</a></h4><p>Perform the exact same base stealing analysis as before but use the win probability matrix instead.  You should be able to reuse almost all of the code from before but with the WP matrix.</p>
<p><em>Questions</em></p>
<ol>
<li>What changed?  What do the new results say about getting a runner into scoring position in order to win?</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="End-of-game-bunting">End of game bunting<a class="anchor-link" href="#End-of-game-bunting">&#182;</a></h4><p>Repeat the bunting analysis but use the win probability matrix instead.</p>
<p><em>Questions</em></p>
<ol>
<li>Does it now make sense to bunt when you only need 1 run?</li>
<li>What does the analysis say about an out now in an end of game situation?</li>
<li>Would you use a bunt strategy?</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>Questions</em></p>
<ol>
<li>What are the limits of kind of analysis?  What kind of caveats are there?  To what kind of hitter and team circumstances does this analysis apply?  Can this analysis still be useful?</li>
<li>Brainstorm some ways you might try to augment the analysis to improve it.</li>
</ol>

</div>
</div>
</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </body>
  
 


</html>
