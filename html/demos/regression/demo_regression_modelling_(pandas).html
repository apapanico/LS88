<!DOCTYPE html>
<html>
  <head><meta charset="utf-8" />

    
    

    <title></title><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.0/dist/bootstrap-toc.min.js"></script>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.0/dist/bootstrap-toc.min.css">  
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css">
    <link rel="stylesheet" href="/LS88/assets/css/style.css">
    <link rel="stylesheet" href="/LS88/assets/css/table.css">
    <link rel="stylesheet" href="/LS88/assets/css/ipy_base.css">
    <link rel="stylesheet" href="/LS88/assets/css/ipy_nb.css">
    <link rel="stylesheet" href="/LS88/assets/css/ipy_tree.css">
    <link rel="stylesheet" href="/LS88/assets/css/ipy_syntax.css">


    <!-- Loading mathjax macro -->
    <!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    <!-- End of mathjax configuration --></head>
    <body>
      
      <!--Navigation bar-->
      
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
	<a class="navbar-brand" href="/LS88/index.html">LS88 - Sports Analytics</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
	<span class="navbar-toggler-icon"></span>
	</button>
	<div class="collapse navbar-collapse" id="navbarSupportedContent">
		<ul class="navbar-nav mr-auto">
			<li class="nav-item">
				<a class="nav-link" href="/LS88/syllabus.html">Syllabus</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/LS88/demos.html">Demos</a>
			</li>
			<!-- <li class="nav-item dropdown">
				<a class="nav-link dropdown-toggle" data-toggle="dropdown">HW</a>
				<div class="dropdown-menu">
					<a class="dropdown-item" href="#">Data8 Review</a>
					<a class="dropdown-item" href="#">Baseball Statistics</a>
					<a class="dropdown-item" href="#">4th Down Bot</a>
				</div>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/LS88/lectures.html">Lectures</a>
			</li> -->
		</ul>
	</div>
</nav>
      <!--end of Navigation bar-->
      
      <div id="bodyContent">
        <div class="container" id="main-container">
          <div class="row">
            <div class="col-2">
                <nav id="toc" data-toggle="toc" class="sticky-top"></nav>
            </div>
            <div class="col-10">
              <div tabindex="-1" id="notebook" class="border-box-sizing">
                <div class="container" id="notebook-container" data-spy="scroll" data-target="#toc">
                  
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Regression-Modeling">Regression Modeling<a class="anchor-link" href="#Regression-Modeling">&#182;</a></h1><p>This demo goes over regression modeling and how we can use it to compute run values and the four factor model like we've already seen.  We'll also see how we can use regression modeling to compute a sophisticated Plus/Minus Rating model that greatly improves on conventional Plus/Minus.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">regression_helper</span> <span class="k">import</span> <span class="n">multiple_regression</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Baseball-Run-Values-from-Regression">Baseball Run Values from Regression<a class="anchor-link" href="#Baseball-Run-Values-from-Regression">&#182;</a></h2><p>Recall the formula for Linear Weights:
$$
  \text{Runs Above Average} = .46\cdot \mathit{1B} + .80\cdot \mathit{2B} + 1.02\cdot \mathit{3B} + 1.40\cdot \mathit{HR} + .33\cdot (\mathit{BB} + \mathit{HBP}) - .25\cdot \mathit{O}
$$</p>
<p>We directly computed the run values for the events through a simple and elegant computation with the play-by-play data.  But there's nothing that stops us from trying to compute the run values through regression.  LWTS is a linear model, after all.</p>
<p>It turns out, using season level data for teams we can do pretty well estimating the run values.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-Data">Load Data<a class="anchor-link" href="#Load-Data">&#182;</a></h3><p>Similar to what we've seen before, we're goint to use the Lahman dataset but cleaned a bit for ease of use with our helper function.  In particular, some columns have been renamed, some extra have been computed, and many have been dropped.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Load lahman_teams.csv obtained from the lahman_main databank. </span>
<span class="c1"># This table is a slight modification of the regular table.</span>
<span class="n">lahman</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;lahman_teams.csv&quot;</span><span class="p">)</span>
<span class="n">lahman</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[2]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>yearID</th>
      <th>franchID</th>
      <th>R</th>
      <th>RAA</th>
      <th>O</th>
      <th>O_nonK</th>
      <th>SO</th>
      <th>X1B</th>
      <th>X2B</th>
      <th>X3B</th>
      <th>HR</th>
      <th>BB</th>
      <th>HBP</th>
      <th>SB</th>
      <th>CS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2000</td>
      <td>ANA</td>
      <td>864</td>
      <td>125.329412</td>
      <td>4054</td>
      <td>3030.0</td>
      <td>1024.0</td>
      <td>995</td>
      <td>309</td>
      <td>34</td>
      <td>236</td>
      <td>608</td>
      <td>47.0</td>
      <td>93.0</td>
      <td>52.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2000</td>
      <td>ARI</td>
      <td>792</td>
      <td>53.329412</td>
      <td>4061</td>
      <td>3086.0</td>
      <td>975.0</td>
      <td>961</td>
      <td>282</td>
      <td>44</td>
      <td>179</td>
      <td>535</td>
      <td>59.0</td>
      <td>97.0</td>
      <td>44.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2000</td>
      <td>ATL</td>
      <td>810</td>
      <td>71.329412</td>
      <td>3999</td>
      <td>2989.0</td>
      <td>1010.0</td>
      <td>1011</td>
      <td>274</td>
      <td>26</td>
      <td>179</td>
      <td>595</td>
      <td>59.0</td>
      <td>148.0</td>
      <td>56.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2000</td>
      <td>BAL</td>
      <td>794</td>
      <td>55.329412</td>
      <td>4041</td>
      <td>3141.0</td>
      <td>900.0</td>
      <td>992</td>
      <td>310</td>
      <td>22</td>
      <td>184</td>
      <td>558</td>
      <td>49.0</td>
      <td>126.0</td>
      <td>65.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2000</td>
      <td>BOS</td>
      <td>792</td>
      <td>53.329412</td>
      <td>4127</td>
      <td>3108.0</td>
      <td>1019.0</td>
      <td>988</td>
      <td>316</td>
      <td>32</td>
      <td>167</td>
      <td>611</td>
      <td>42.0</td>
      <td>43.0</td>
      <td>30.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Our-first-regression-model">Our first regression model<a class="anchor-link" href="#Our-first-regression-model">&#182;</a></h3><p>Let's build our first regression model.  We need to tell the function <code>multiple_regression</code> which is the dependent variable (the observation) and the independent variables (the inputs).</p>
<p>The dependent variable is going to be Runs Above Average and the independent variables will be the events.</p>
<p>Comparing the regression to the run values we obtained earlier, we find pretty similar results.  It's hard to argue wih the effectiveness of the regression.</p>
<table>
<thead><tr>
<th>Event</th>
<th>Run Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Out</td>
<td>-0.287</td>
</tr>
<tr>
<td>1B</td>
<td>0.462</td>
</tr>
<tr>
<td>2B</td>
<td>0.781</td>
</tr>
<tr>
<td>3B</td>
<td>1.085</td>
</tr>
<tr>
<td>HR</td>
<td>1.383</td>
</tr>
<tr>
<td>BB</td>
<td>0.306</td>
</tr>
<tr>
<td>HBP</td>
<td>0.336</td>
</tr>
</tbody>
</table>
<p>From FanGraphs, the run values for SB and CS are .2 and -(2 * run_per_out + 0.075) (generally about -.4).  Our findings align pretty well with that.</p>
<p>We could have used additional variables for the regression.  We're a bit limited based on the Lahman dataset so we cannot distinguish between regular walks and intentional walks, or fielder's choice, or reaching base on an error.  Luckily we've got most of the events and the most important ones at that.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dep_vars</span> <span class="o">=</span> <span class="s1">&#39;RAA&#39;</span>
<span class="n">ind_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;X1B&#39;</span><span class="p">,</span> <span class="s1">&#39;X2B&#39;</span><span class="p">,</span> <span class="s1">&#39;X3B&#39;</span><span class="p">,</span> <span class="s1">&#39;HR&#39;</span><span class="p">,</span> <span class="s1">&#39;BB&#39;</span><span class="p">,</span> <span class="s1">&#39;HBP&#39;</span><span class="p">,</span> <span class="s1">&#39;SB&#39;</span><span class="p">,</span> <span class="s1">&#39;CS&#39;</span><span class="p">]</span>
<span class="n">coefs</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">multiple_regression</span><span class="p">(</span><span class="n">dep_vars</span><span class="p">,</span> <span class="n">ind_vars</span><span class="p">,</span> <span class="n">lahman</span><span class="p">)</span>
<span class="n">coefs</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[3]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>O     -0.272014
X1B    0.475447
X2B    0.743046
X3B    1.073670
HR     1.433816
BB     0.286383
HBP    0.333042
SB     0.184180
CS    -0.389898
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Stolen-Base-Breakeven-Probability">Stolen Base Breakeven Probability<a class="anchor-link" href="#Stolen-Base-Breakeven-Probability">&#182;</a></h4><p>The breakeven probability for a stolen base tells us how likely a stolen base needs to be to make it an even proposition in terms of run expectancy.  Research has shown that some poorly constructed regression models can fail to provide a properly calibrated model with respect to the breakeven probability.  Our model is pretty close to what we should expect, which is about 70%.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;CS&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;SB&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;CS&#39;</span><span class="p">]))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[4]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>0.6791727053867741</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Residuals">Residuals<a class="anchor-link" href="#Residuals">&#182;</a></h4><p>We can look a scatterplot between RAA and the errors from the regression.  The doesn't look eggregiously bad so it looks like we're doing a fair job of caputing run scoring with the events we have used.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lahman</span><span class="p">[</span><span class="s1">&#39;RAA&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Are-Ks-more-costly-than-other-outs?">Are Ks more costly than other outs?<a class="anchor-link" href="#Are-Ks-more-costly-than-other-outs?">&#182;</a></h3><p>Among other variables we could have used is the strikeout.  Presumably striking out and not putting the ball in play, even if it results in an out, should be less valuable.  So is there much of a distinction between regular outs and strikeouts?</p>
<p>The evidence is not strong that it's hugely different in value but the diffence is slightly larger in magnitude than
what we computed using play-by-play data.</p>
<table>
<thead><tr>
<th>Event</th>
<th>Run Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Out</td>
<td>-0.287</td>
</tr>
<tr>
<td>K</td>
<td>-0.292</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ind_vars_with_K</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;O_nonK&#39;</span><span class="p">,</span> <span class="s1">&#39;SO&#39;</span><span class="p">,</span> <span class="s1">&#39;X1B&#39;</span><span class="p">,</span> <span class="s1">&#39;X2B&#39;</span><span class="p">,</span> <span class="s1">&#39;X3B&#39;</span><span class="p">,</span> <span class="s1">&#39;HR&#39;</span><span class="p">,</span> <span class="s1">&#39;BB&#39;</span><span class="p">,</span> <span class="s1">&#39;HBP&#39;</span><span class="p">,</span> <span class="s1">&#39;SB&#39;</span><span class="p">,</span> <span class="s1">&#39;CS&#39;</span><span class="p">]</span>
<span class="n">coefs_with_K</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">multiple_regression</span><span class="p">(</span><span class="n">dep_vars</span><span class="p">,</span> <span class="n">ind_vars_with_K</span><span class="p">,</span> <span class="n">lahman</span><span class="p">)</span>
<span class="n">coefs_with_K</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[6]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>O_nonK   -0.261232
SO       -0.280164
X1B       0.454179
X2B       0.731634
X3B       1.090536
HR        1.436531
BB        0.286626
HBP       0.333416
SB        0.189289
CS       -0.409027
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="What-happens-if-we-only-use-a-year-of-data?">What happens if we only use a year of data?<a class="anchor-link" href="#What-happens-if-we-only-use-a-year-of-data?">&#182;</a></h3><p>We used all years since 2000 to build our regression.  What if we want to compute the run values for a single year, say 2016?  Let's sluff off the rest of the data and run our regression.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lahman_2016</span> <span class="o">=</span> <span class="n">lahman</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lahman</span><span class="p">[</span><span class="s1">&#39;yearID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2016</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">lahman_2016</span><span class="p">[</span><span class="s1">&#39;RAA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lahman_2016</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">lahman_2016</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">coefs_2016</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">multiple_regression</span><span class="p">(</span><span class="n">dep_vars</span><span class="p">,</span> <span class="n">ind_vars</span><span class="p">,</span> <span class="n">lahman_2016</span><span class="p">)</span>
<span class="n">coefs_2016</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[7]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>O     -0.259893
X1B    0.383224
X2B    1.132642
X3B    0.837048
HR     1.314087
BB     0.186552
HBP    0.535969
SB     0.134982
CS    -0.005307
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The end result is not good.  We don't know the ground truth but we have a good idea of where things should be and in this case, some of these values are ludicrous.  The value of a double is way off, especially given that it's worth more than a triple.  The values for HBP and BB are out of whack too.  Most alarmingly, the value for CS is now positive.</p>
<p>So what happened?</p>
<p>Not enough data.  That's pretty much it.  One season of MLB has only 30 observations and we tried to estimate 9 coeffients.  30 data points would possibly be okay if we wanted to measure 1 effect.  But 9 simultaneous effects?  No way.</p>
<p>The play-by-play method worked for a single season but this regression approach requires multiple years.  This is not great if we want to capture changing run environments.  A potential solution (if we wanted to continue with regression modeling) would be to build a regression using the play-by-play data.  That would be enough data.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="What-happens-if-we-only-use-a-single-variable?">What happens if we only use a single variable?<a class="anchor-link" href="#What-happens-if-we-only-use-a-single-variable?">&#182;</a></h3><p>Let's return to our data for the 2000s but now we'll explore an important phenomenon with regression modeling: misspecification.</p>
<p>The underlying mathematical theory says that if you have all the independent variables that the observation depends on (and among other assumptions the true model is linear), regression modeling will properly estimate the coefficients of the model.</p>
<p>So far we've seen regression models that do pretty well because we're doing a pretty good job of specifying the model.  Let's see just how the regression could have produced junk results if we did not properly specify the regression model.</p>
<p>We specify an constant term in <code>multiple_regression</code> because it provides an intercept to the regression line, which is very much needed as indicated by the scatter plot.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dep_vars</span> <span class="o">=</span> <span class="s1">&#39;RAA&#39;</span>
<span class="n">ind_vars</span> <span class="o">=</span> <span class="s1">&#39;X2B&#39;</span>
<span class="n">coefs</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">multiple_regression</span><span class="p">(</span><span class="n">dep_vars</span><span class="p">,</span> <span class="n">ind_vars</span><span class="p">,</span> <span class="n">lahman</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lahman</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ind_vars</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">dep_vars</span><span class="p">)</span>
<span class="n">coefs</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[8]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>Intercept   -544.261391
X2B            1.886880
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>While it feels like we should have been able to estimate the individual effects of the events, the poor results show that the simultaneous effects of the different events make it so that you definitely need to incorporate all the events to get proper results.</p>
<p>This is huge part of any statistical study using regression: you need to collect as much information as you can that likely is relevant because if you fail to account for relevant information, your results will likely be corrupted and erroneous.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Four-Factor-Model">Four Factor Model<a class="anchor-link" href="#Four-Factor-Model">&#182;</a></h2><p>Recall Dean Oliver's four factor model for basketball:
\begin{align*}
  \text{Team Performance} &amp; = .4 \cdot Z(\mathit{eFG\%} -  \mathit{eFG\%}_{\text{Opp}}) \\
  &amp; \quad - .25 \cdot Z(\text{Turnover Rate} - \text{Turnover Rate}_{\text{Opp}}) \\
  &amp; \quad + .2 \cdot Z(\mathit{OREB\%} -  \mathit{OREB\%}_{\text{Opp}}) \\
  &amp; \quad  + .15 \cdot Z(\text{FT Rate} - \text{FT Rate}_{\text{Opp}})
\end{align*}</p>
<p>The model tried to explain team performance through four fundamental factors.  Dean Oliver prescribed his own relative importance to the factors as 40% for efficient shooting, 25% for turnovers, 20% for rebounding, and 15% for free throw attempts.   Where did Dean Oliver get those values?  Are they the best?</p>
<p>We don't know where he got those values but we can see what regression says for the relative importance.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-Data">Load Data<a class="anchor-link" href="#Load-Data">&#182;</a></h3><p>We'll use similar data we used before but cleaned up to have the just the four factors and other relevant data.</p>
<p>Recall the two values:
\begin{align*}
  \text{Rating Ratio} &amp; = \frac{\text{Off. Rating}}{\text{Def. Rating}} \\
  \text{Log Rating Ratio} &amp; = \log\text{Rating Ratio}
\end{align*}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">nba_teams_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;team_season_ff_data.csv&#39;</span><span class="p">)</span>

<span class="n">nba_teams</span> <span class="o">=</span> <span class="n">nba_teams_full</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nba_teams_full</span><span class="o">.</span><span class="n">season</span> <span class="o">&gt;=</span> <span class="mi">2000</span><span class="p">]</span>
<span class="n">nba_teams</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[9]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>team</th>
      <th>season</th>
      <th>win_pct</th>
      <th>rtg_rat</th>
      <th>log_rtg_rat</th>
      <th>eFG</th>
      <th>Tov</th>
      <th>Reb</th>
      <th>Ftr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>516</th>
      <td>ORL</td>
      <td>2000</td>
      <td>0.524390</td>
      <td>1.010774</td>
      <td>0.010716</td>
      <td>0.380505</td>
      <td>-1.299623</td>
      <td>-0.374888</td>
      <td>-2.114058</td>
    </tr>
    <tr>
      <th>517</th>
      <td>OKC</td>
      <td>2000</td>
      <td>0.536585</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.083395</td>
      <td>0.241673</td>
      <td>-0.335741</td>
      <td>0.544216</td>
    </tr>
    <tr>
      <th>518</th>
      <td>UTA</td>
      <td>2000</td>
      <td>0.646341</td>
      <td>1.050781</td>
      <td>0.049534</td>
      <td>0.876757</td>
      <td>-0.388508</td>
      <td>1.107366</td>
      <td>-0.801943</td>
    </tr>
    <tr>
      <th>519</th>
      <td>CHI</td>
      <td>2000</td>
      <td>0.182927</td>
      <td>0.905871</td>
      <td>-0.098858</td>
      <td>-1.824042</td>
      <td>0.602356</td>
      <td>-1.022925</td>
      <td>-0.950757</td>
    </tr>
    <tr>
      <th>520</th>
      <td>CLE</td>
      <td>2000</td>
      <td>0.365854</td>
      <td>0.956149</td>
      <td>-0.044842</td>
      <td>-0.652338</td>
      <td>0.958817</td>
      <td>0.290324</td>
      <td>-0.252797</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Four-Factors-and-Winning-Pct">Four Factors and Winning Pct<a class="anchor-link" href="#Four-Factors-and-Winning-Pct">&#182;</a></h3><p>Let's first look at a model for winning percentage using the four factors.  Since winning percentage is centered around .500, we need to include a constant term to center our model.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dep_vars</span> <span class="o">=</span> <span class="s1">&#39;win_pct&#39;</span>
<span class="n">ind_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;eFG&#39;</span><span class="p">,</span> <span class="s1">&#39;Tov&#39;</span><span class="p">,</span> <span class="s1">&#39;Reb&#39;</span><span class="p">,</span> <span class="s1">&#39;Ftr&#39;</span><span class="p">]</span>
<span class="n">coefs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">multiple_regression</span><span class="p">(</span><span class="n">dep_vars</span><span class="p">,</span> <span class="n">ind_vars</span><span class="p">,</span> <span class="n">nba_teams</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">coefs</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[10]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>Intercept    0.500057
eFG          0.122653
Tov         -0.058226
Reb          0.039497
Ftr          0.034653
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can rescale the non-intercept coefficients to sum to 100 in absolute value so they are relative percentages, as Dean Oliver used.  We got reasonably close to Dean Oliver's prescribed values but it turns out that our model suggests lower weights for <strong>Tov</strong>, <strong>Reb</strong>, and <strong>FTR</strong> in exchange for more importance for <strong>eFG</strong>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">factor_coefs</span> <span class="o">=</span> <span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;eFG&#39;</span><span class="p">:]</span>
<span class="n">factor_coefs</span> <span class="o">/</span> <span class="n">factor_coefs</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[11]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>eFG    48.093889
Tov   -22.831246
Reb    15.487149
Ftr    13.587717
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Four-Factors-and-the-log-Rating-Ratio">Four Factors and the log Rating Ratio<a class="anchor-link" href="#Four-Factors-and-the-log-Rating-Ratio">&#182;</a></h3><p>We can also look at our ole Pythagorean Expectation pal the log rating ratio.  There is no need for an intercept for the log rating ratio since it's centered very close to 0.</p>
<p>Perhaps not shockingly, we get similar results for the relative importance.  The <strong>eFG</strong> factor again is more relevant according to this regression.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dep_vars</span> <span class="o">=</span> <span class="s1">&#39;log_rtg_rat&#39;</span>
<span class="n">ind_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;eFG&#39;</span><span class="p">,</span> <span class="s1">&#39;Tov&#39;</span><span class="p">,</span> <span class="s1">&#39;Reb&#39;</span><span class="p">,</span> <span class="s1">&#39;Ftr&#39;</span><span class="p">]</span>
<span class="n">coefs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">multiple_regression</span><span class="p">(</span><span class="n">dep_vars</span><span class="p">,</span> <span class="n">ind_vars</span><span class="p">,</span> <span class="n">nba_teams</span><span class="p">)</span>
<span class="n">coefs</span> <span class="o">/</span> <span class="n">coefs</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[12]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>eFG    0.476750
Tov   -0.229748
Reb    0.161694
Ftr    0.131809
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="As-before,-what-if-only-include-one-variable-in-the-regression?">As before, what if only include one variable in the regression?<a class="anchor-link" href="#As-before,-what-if-only-include-one-variable-in-the-regression?">&#182;</a></h4><p>The resulting coefficients from the misspecified models are all off, and not in a consistent direction.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dep_vars</span> <span class="o">=</span> <span class="s1">&#39;log_rtg_rat&#39;</span>
<span class="n">ind_vars</span> <span class="o">=</span> <span class="s1">&#39;eFG&#39;</span>
<span class="n">coefs_misspecified</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">multiple_regression</span><span class="p">(</span><span class="n">dep_vars</span><span class="p">,</span> <span class="n">ind_vars</span><span class="p">,</span> <span class="n">nba_teams</span><span class="p">)</span>
<span class="n">coefs_misspecified</span><span class="p">[</span><span class="n">ind_vars</span><span class="p">],</span> <span class="n">coefs</span><span class="p">[</span><span class="n">ind_vars</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[13]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>(0.040228876586653445, 0.037733425455504059)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="By-Games">By Games<a class="anchor-link" href="#By-Games">&#182;</a></h3><p>If you recall, the four factor model was also effective for explaning game performance.  Compared to the season level, the performance was quite similar though the games just had more variation.  The regression should still be more effective.  How does that play out here?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">games</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;game_ff_data_2016.csv&#39;</span><span class="p">)</span>
<span class="n">games</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[14]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GAME_ID</th>
      <th>TEAM_NAME</th>
      <th>OPP_TEAM_NAME</th>
      <th>log_rtg_rat</th>
      <th>eFG</th>
      <th>Tov</th>
      <th>Reb</th>
      <th>Ftr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>21600001</td>
      <td>Knicks</td>
      <td>Cavaliers</td>
      <td>-0.231130</td>
      <td>-1.392594</td>
      <td>0.751141</td>
      <td>-0.344226</td>
      <td>0.335651</td>
    </tr>
    <tr>
      <th>1</th>
      <td>21600002</td>
      <td>Jazz</td>
      <td>Trail Blazers</td>
      <td>-0.128505</td>
      <td>-0.760523</td>
      <td>0.071183</td>
      <td>-0.015786</td>
      <td>-0.676140</td>
    </tr>
    <tr>
      <th>2</th>
      <td>21600003</td>
      <td>Spurs</td>
      <td>Warriors</td>
      <td>0.239358</td>
      <td>0.318357</td>
      <td>-0.448785</td>
      <td>2.341258</td>
      <td>0.536404</td>
    </tr>
    <tr>
      <th>3</th>
      <td>21600004</td>
      <td>Magic</td>
      <td>Heat</td>
      <td>-0.091060</td>
      <td>-0.967581</td>
      <td>-0.148804</td>
      <td>-0.576067</td>
      <td>1.315323</td>
    </tr>
    <tr>
      <th>4</th>
      <td>21600005</td>
      <td>Pacers</td>
      <td>Mavericks</td>
      <td>0.079820</td>
      <td>0.438232</td>
      <td>0.191175</td>
      <td>-0.199326</td>
      <td>1.660617</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For 2016, the weight is just a bit more on eFG.  But it appears generally consistent with season level.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dep_vars</span> <span class="o">=</span> <span class="s1">&#39;log_rtg_rat&#39;</span>
<span class="n">ind_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;eFG&#39;</span><span class="p">,</span> <span class="s1">&#39;Tov&#39;</span><span class="p">,</span> <span class="s1">&#39;Reb&#39;</span><span class="p">,</span> <span class="s1">&#39;Ftr&#39;</span><span class="p">]</span>
<span class="n">coefs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">multiple_regression</span><span class="p">(</span><span class="n">dep_vars</span><span class="p">,</span> <span class="n">ind_vars</span><span class="p">,</span> <span class="n">games</span><span class="p">)</span>
<span class="n">coefs</span> <span class="o">=</span> <span class="n">coefs</span> <span class="o">/</span> <span class="n">coefs</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">coefs</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[15]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>eFG    0.496854
Tov   -0.220977
Reb    0.191796
Ftr    0.090373
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We should be heartened by the overall stability of the regression modeling.  It's a good sign when the model is stable and not overly sensitive to changing data.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Plus/Minus-Regression">Plus/Minus Regression<a class="anchor-link" href="#Plus/Minus-Regression">&#182;</a></h2><p>We can think of a plus/minus rating as simultaneous impacts of players on team performance.  If we track performance over stints, where the same 10 players are on the court, we can measure a player's impact using a regression.</p>
<p>The model is:
$$
    \mathrm{HomeNetRating}_t = \mathrm{HomeCourtAdv} + \mathrm{Sum}(\mbox{Home Player $i$'s net rating if player $i$ is on the during the $t$-th stint}) - \mathrm{Sum}(\mbox{Away Player $i$'s net rating if player $i$ is on the during the $t$-th stint}).
$$</p>
<p>Using play-by-play data from 2014-15, the stint data is collected into a table.  For each stint, possessions and scoring is tracked as well as the 10 players on the court.  There about about 40k stints over the nba season.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Stint-data">Stint data<a class="anchor-link" href="#Stint-data">&#182;</a></h3><p>Here we can see the data on all the stints but this isn't really effective for performing a regression analysis.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">regression_helper</span> <span class="k">import</span> <span class="n">multiple_regression_big</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;nba_stints_2015_full.csv.gz&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>(40453, 13)
</pre>
</div>
</div>

<div class="output_area">

<div class="prompt output_prompt">Out[16]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>away</th>
      <th>away_ortg</th>
      <th>away_poss</th>
      <th>away_pts</th>
      <th>away_unit</th>
      <th>home</th>
      <th>home_ortg</th>
      <th>home_poss</th>
      <th>home_pts</th>
      <th>home_unit</th>
      <th>net_poss</th>
      <th>home_netpts</th>
      <th>home_netrtg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Warriors</td>
      <td>100.0</td>
      <td>4</td>
      <td>4</td>
      <td>['Stephen Curry', 'Klay Thompson', 'Andre Iguo...</td>
      <td>Lakers</td>
      <td>275.0</td>
      <td>4</td>
      <td>11</td>
      <td>['Ronnie Price', 'Wayne Ellington', 'Wesley Jo...</td>
      <td>8</td>
      <td>7</td>
      <td>175.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Kings</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>['Ray McCallum', 'Ben McLemore', 'Nik Stauskas...</td>
      <td>Nets</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
      <td>['Jarrett Jack', 'Alan Anderson', 'Joe Johnson...</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Warriors</td>
      <td>170.0</td>
      <td>10</td>
      <td>17</td>
      <td>['Stephen Curry', 'Klay Thompson', 'Harrison B...</td>
      <td>Lakers</td>
      <td>90.0</td>
      <td>10</td>
      <td>9</td>
      <td>['Ronnie Price', 'Wayne Ellington', 'Wesley Jo...</td>
      <td>20</td>
      <td>-8</td>
      <td>-80.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Warriors</td>
      <td>0.0</td>
      <td>2</td>
      <td>0</td>
      <td>['Stephen Curry', 'Klay Thompson', 'Harrison B...</td>
      <td>Lakers</td>
      <td>200.0</td>
      <td>3</td>
      <td>6</td>
      <td>['Ronnie Price', 'Wayne Ellington', 'Wesley Jo...</td>
      <td>5</td>
      <td>6</td>
      <td>200.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Warriors</td>
      <td>100.0</td>
      <td>1</td>
      <td>1</td>
      <td>['Stephen Curry', 'Klay Thompson', 'Harrison B...</td>
      <td>Lakers</td>
      <td>NaN</td>
      <td>0</td>
      <td>2</td>
      <td>['Ronnie Price', 'Wayne Ellington', 'Wesley Jo...</td>
      <td>1</td>
      <td>1</td>
      <td>-100.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Stint-Data-for-Regression">Stint Data for Regression<a class="anchor-link" href="#Stint-Data-for-Regression">&#182;</a></h3><p>Instead, we use encoded data that is actually numeric.  Each player is represented by a 0 or 1.  If a player is on the court during the stint, he will have a 1.  Most of the entries will be 0.</p>
<p>HCA naturally stands for home court advantage and is actually just a column of 1s.  This is like fitting an intercept.</p>
<p>We do this via a big model where each variable corresponds to a player and is 0 if the player was <em>not</em> on the court during the stint and 1 if he was.  This creates a table of 0s and 1s of size Number of Stints by Number of Players + 1.  The +1 is for an extra variable representing the home court advantage.  Each row will only have 10 1s.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[17]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">stints</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;nba_stints_2015_binary.csv.gz&#39;</span><span class="p">)</span>
<span class="n">players</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stints</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>

<span class="n">stints</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[17]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>net_rtg</th>
      <th>net_poss</th>
      <th>HCA</th>
      <th>A.J. Price</th>
      <th>Aaron Brooks</th>
      <th>Aaron Gordon</th>
      <th>Adreian Payne</th>
      <th>Al Horford</th>
      <th>Al Jefferson</th>
      <th>Al-Farouq Aminu</th>
      <th>...</th>
      <th>Will Barton</th>
      <th>Will Bynum</th>
      <th>Will Cherry</th>
      <th>Willie Green</th>
      <th>Wilson Chandler</th>
      <th>Xavier Henry</th>
      <th>Zach LaVine</th>
      <th>Zach Randolph</th>
      <th>Zaza Pachulia</th>
      <th>Zoran Dragic</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>175.0</td>
      <td>8</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.0</td>
      <td>1</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-80.0</td>
      <td>20</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>200.0</td>
      <td>5</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-100.0</td>
      <td>1</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 496 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Adjusted-Plus/Minus">Adjusted Plus/Minus<a class="anchor-link" href="#Adjusted-Plus/Minus">&#182;</a></h3><p>We need a more advanced solver for the regression model that can handle this much bigger problem.  This is where <code>multiple_regression_big</code> comes in.</p>
<p>We set <code>net_rtg</code> as the dep_var and we set <code>HCA</code> and the players as the independent vars.  We also utilize weights: each stint has a total number of possessions.  We want the results from stints with more possessions to be weighted more than other possessions.</p>
<p>After we compute the regression model, we can see some of the results that come out for the first ten players alphabetically.  These are the <em>Adjusted Plus/Minus</em> or APM ratings</p>
<p>The result of this regression model is a player rating which should indicate the impact the player had on Net Rating relative to league average.  A positive value obviously indicates a positive impact on Net Rating.  We could in fact use this to construct lineup net ratings above average by summing across a lineup of players.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[18]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dep_var</span> <span class="o">=</span> <span class="s1">&#39;net_rtg&#39;</span>
<span class="n">ind_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;HCA&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">players</span>
<span class="n">apm</span> <span class="o">=</span> <span class="n">multiple_regression_big</span><span class="p">(</span><span class="n">dep_var</span><span class="p">,</span> <span class="n">ind_vars</span><span class="p">,</span> <span class="n">stints</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;net_poss&#39;</span><span class="p">)</span>
<span class="n">apm</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[18]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>A.J. Price        -13.157560
Aaron Brooks       -2.429854
Aaron Gordon      -14.688712
Adreian Payne     -20.732361
Al Horford         -9.465314
Al Jefferson      -15.851161
Al-Farouq Aminu    -1.818711
Alan Anderson      -3.359995
Alec Burks        -15.805193
Alex Kirk         -57.585697
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's take a look at the histogram plot.</p>
<p>This is odd... there are some very large values.  This is supposed to be the player's impact on net rating and there are values over 100 in magnitude??</p>
<p>Did we do something wrong?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">apm</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[19]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>&lt;matplotlib.axes._subplots.AxesSubplot at 0x111e70550&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's look at the top ranked players.</p>
<p>Geez, who are some of these guys?  Where's Lebron??</p>
<p>What happened?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[20]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">apm_HCA</span> <span class="o">=</span> <span class="n">apm</span><span class="p">[</span><span class="s1">&#39;HCA&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Home Court Advantage for Net Rating: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">apm_HCA</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top 20 by APM</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="mi">40</span><span class="o">*</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">apm</span><span class="p">[</span><span class="n">players</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bottom 20 by APM</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="mi">40</span><span class="o">*</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">apm</span><span class="p">[</span><span class="n">players</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Home Court Advantage for Net Rating: 2.56

Top 20 by APM
========================================
Jerrelle Benimon      132.576264
Malcolm Lee            93.616436
Sim Bhullar            85.079525
Eric Moreland          38.696007
Toure&#39; Murry           13.305698
Lucas Nogueira         12.653926
Sean Kilpatrick        12.114689
David Stockton         10.261257
Stephen Curry           8.394628
C.J. Wilcox             8.290789
Cory Jefferson          6.650653
Russ Smith              6.561828
Xavier Henry            6.152980
Quincy Miller           5.741163
James Harden            5.598064
Glenn Robinson III      5.164508
Devyn Marble            5.029127
Kawhi Leonard           4.960071
Ricky Rubio             4.284679
Derrick Rose            4.274820

Bottom 20 by APM
========================================
Julius Randle         -106.443050
Bruno Caboclo          -89.190773
David Wear             -80.808367
Kalin Lucas            -78.895234
Mike Malone            -66.356134
Alex Kirk              -57.585697
Patrick Christopher    -56.450373
Glen Rice Jr.          -49.021189
Andrei Kirilenko       -47.985882
Brandon Rush           -43.625687
Reggie Williams        -41.238514
Dahntay Jones          -40.898542
Landry Fields          -39.769842
Brendan Haywood        -38.613047
John Lucas III         -38.562682
Tyrus Thomas           -36.637823
Seth Curry             -34.809803
Malcolm Thomas         -33.100928
Zoran Dragic           -32.684668
Will Bynum             -32.404986
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Penalizing-the-Least-Squares-Fit:-Regularized-Adjusted-Plus-Minus-(xRAPM)">Penalizing the Least Squares Fit: Regularized Adjusted Plus Minus (xRAPM)<a class="anchor-link" href="#Penalizing-the-Least-Squares-Fit:-Regularized-Adjusted-Plus-Minus-(xRAPM)">&#182;</a></h3><p>We just ran into a few issues:</p>
<ul>
<li>Players who we should have dropped due to not having many minutes.  If they have a raw net rating of 200 in 1 possession, the regression will still try to aggressively optimize and give that player a high rating.  We can bucket those players together or force the regression optimizer to not be so aggressive</li>
<li>Lineups do not behave like randomized controlled trials.  Given nine players on the court, we can do a really good job predicting the tenth.  Sometimes two players almost always play together.  Or two players switch for each other.</li>
<li>This lack of randomization leads to a condition called <em>multicollinearity</em> and is a huge potential problem in multiple regression problems.  Due to issues that can be derived/explained with Linear Algebra, if multicollinearity is present the regression will likely falter and not be able to distinguish well what is happening.  </li>
</ul>
<p>Our solution is to use something called <em>penalization</em> or <em>regularization</em>.</p>
<p>Instead of just aggressively minimizing the mean square error, we reframe the regression to simultaneously minimize mean square error but penalize aggressive fitting by the optimizer.  If the optimization wants to assign a big rating alue to a player, it better have a lot of evidence behind it, ie. the reduction in the least squares needs to offset the penalty imposed.</p>
<p>What exactly is the penalty?  We penalize the sum of squares of the coefficients and we introduce a penalty parameter that quantifies the strength of this penalty.  This parameter is our choice but there are methods (beyond the scope of this demo) that can suggest a good value.</p>
<p>The result of this is a statistic attributed to Jerry Engelmann called <em>Regularized Adjusted Plus Minus</em> or xRAPM.  It is actually the cousin/basis for ESPN's Real Plus/Minus statistic.</p>
<p>We use a new function to perform this: <code>multiple_regression_big_with_penalty</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[21]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">regression_helper</span> <span class="k">import</span> <span class="n">multiple_regression_big_with_penalty</span>

<span class="n">rapm</span> <span class="o">=</span> <span class="n">multiple_regression_big_with_penalty</span><span class="p">(</span><span class="s1">&#39;net_rtg&#39;</span><span class="p">,</span> <span class="n">ind_vars</span><span class="p">,</span> <span class="n">stints</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;net_poss&#39;</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="mf">3400.</span><span class="p">)</span>
<span class="n">rapm</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[21]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>A.J. Price        -1.590256
Aaron Brooks       2.080514
Aaron Gordon      -1.926648
Adreian Payne     -3.507206
Al Horford         0.290931
Al Jefferson      -1.081350
Al-Farouq Aminu    4.225618
Alan Anderson      2.484453
Alec Burks        -1.548532
Alex Kirk         -0.737028
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This looks way better.  Now we see the people we expect to see at the top.  There are some interesting names at the top like Kyle Korver or Kelly Olynyk.  I certainly would have expected them to rank so high.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[22]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rapm</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="n">rapm_HCA</span> <span class="o">=</span> <span class="n">rapm</span><span class="p">[</span><span class="s1">&#39;HCA&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Home Court Advantage for Net Rating: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rapm_HCA</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top 20 by RAPM</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="mi">40</span><span class="o">*</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rapm</span><span class="p">[</span><span class="n">players</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bottom 20 by RAPM</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="mi">40</span><span class="o">*</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rapm</span><span class="p">[</span><span class="n">players</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Home Court Advantage for Net Rating: 2.63

Top 20 by RAPM
========================================
Stephen Curry        8.928824
Draymond Green       8.667916
LeBron James         7.802141
Kawhi Leonard        7.729774
Kyle Korver          7.387177
Anthony Davis        7.067565
James Harden         7.051841
Chris Paul           6.376656
Zach Randolph        6.180225
DeMarcus Cousins     6.135926
Khris Middleton      6.072801
Kelly Olynyk         6.015783
Timofey Mozgov       5.756816
Tony Allen           5.498612
Danny Green          5.460229
Dwight Howard        5.210680
Kyle Lowry           5.128116
LaMarcus Aldridge    5.009648
George Hill          4.924816
C.J. Miles           4.886965

Bottom 20 by RAPM
========================================
Brandon Rush        -7.601458
Perry Jones         -6.110350
Martell Webster     -5.843273
Zach LaVine         -5.601537
Anthony Bennett     -5.472785
Andrea Bargnani     -5.303380
Luke Babbitt        -5.143458
Archie Goodwin      -5.129915
Landry Fields       -5.086030
Derrick Williams    -5.045857
Jason Smith         -4.739541
Udonis Haslem       -4.652376
Johnny O&#39;Bryant     -4.600584
Jabari Brown        -4.589360
Joffrey Lauvergne   -4.456967
Mike Miller         -4.428104
Samuel Dalembert    -4.398256
Ray McCallum        -4.369180
Malcolm Thomas      -4.348892
Kris Humphries      -4.261560
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="How-penalizing-the-coefficients-cleans-things-up">How penalizing the coefficients cleans things up<a class="anchor-link" href="#How-penalizing-the-coefficients-cleans-things-up">&#182;</a></h3><p>Let's take a look at some Grizzlies players.  Of particular interest is Kosta Koufos and Marc Gasol.  They are both centers who rarely played together but combined covered most of the possessions at center for the grizzlies.</p>
<p>We shouldn't be so outright dismissive of the APM results just because these three players look "off".  But one thing you can see is how the gap between Koufos and Gasol was shrunk in half (and of course they went from negative to positive).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[23]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">apm</span><span class="p">[</span><span class="s2">&quot;Kosta Koufos&quot;</span><span class="p">],</span> <span class="n">apm</span><span class="p">[</span><span class="s2">&quot;Marc Gasol&quot;</span><span class="p">],</span> <span class="n">apm</span><span class="p">[</span><span class="s2">&quot;Zach Randolph&quot;</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[23]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>(-3.6586029004971907, -5.756523187910501, 1.9971984565353815)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[24]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rapm</span><span class="p">[</span><span class="s2">&quot;Kosta Koufos&quot;</span><span class="p">],</span> <span class="n">rapm</span><span class="p">[</span><span class="s2">&quot;Marc Gasol&quot;</span><span class="p">],</span> <span class="n">rapm</span><span class="p">[</span><span class="s2">&quot;Zach Randolph&quot;</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[24]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>(2.5769413915697714, 1.2791000225734037, 6.1802253956219388)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When looking at all Grizzly players, you see how the ratings are cleaned up a lot.  Note that not all of the relative positionings are the same.  Some players went from negative to positive, some switched order.  This suggests we're doing what we want to do: not just contract everyone's rating towards 0 but find a result that is more stable.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[25]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">griz_players</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Jordan Adams&#39;</span><span class="p">,</span> <span class="s1">&#39;Tony Allen&#39;</span><span class="p">,</span> <span class="s1">&#39;Nick Calathes&#39;</span><span class="p">,</span> <span class="s1">&#39;Vince Carter&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Mike Conley&#39;</span><span class="p">,</span> <span class="s1">&#39;Marc Gasol&#39;</span><span class="p">,</span> <span class="s1">&#39;JaMychal Green&#39;</span><span class="p">,</span> <span class="s1">&#39;Jeff Green&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Kosta Koufos&#39;</span><span class="p">,</span> <span class="s1">&#39;Courtney Lee&#39;</span><span class="p">,</span> <span class="s1">&#39;Jon Leuer&#39;</span><span class="p">,</span> <span class="s1">&#39;Kalin Lucas&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Quincy Pondexter&#39;</span><span class="p">,</span> <span class="s1">&#39;Tayshaun Prince&#39;</span><span class="p">,</span> <span class="s1">&#39;Zach Randolph&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Russ Smith&#39;</span><span class="p">,</span> <span class="s1">&#39;Jarnell Stokes&#39;</span><span class="p">,</span> <span class="s1">&#39;Tyrus Thomas&#39;</span><span class="p">,</span> <span class="s1">&#39;Beno Udrih&#39;</span><span class="p">]</span>
<span class="n">apm</span><span class="p">[</span><span class="n">griz_players</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[25]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>Jordan Adams        -7.441164
Tony Allen          -2.854986
Nick Calathes       -4.018557
Vince Carter       -11.983109
Mike Conley        -10.320909
Marc Gasol          -5.756523
JaMychal Green     -14.369896
Jeff Green         -18.321378
Kosta Koufos        -3.658603
Courtney Lee        -9.407771
Jon Leuer          -15.794320
Kalin Lucas        -78.895234
Quincy Pondexter    -8.919124
Tayshaun Prince    -15.254515
Zach Randolph        1.997198
Russ Smith           6.561828
Jarnell Stokes     -17.335247
Tyrus Thomas       -36.637823
Beno Udrih         -13.947333
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[26]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rapm</span><span class="p">[</span><span class="n">griz_players</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[26]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>Jordan Adams        0.843452
Tony Allen          5.498612
Nick Calathes       3.064865
Vince Carter       -0.753477
Mike Conley         1.493061
Marc Gasol          1.279100
JaMychal Green     -0.447767
Jeff Green         -4.065667
Kosta Koufos        2.576941
Courtney Lee        0.970357
Jon Leuer          -1.639624
Kalin Lucas        -0.415726
Quincy Pondexter   -0.218636
Tayshaun Prince    -2.939692
Zach Randolph       6.180225
Russ Smith          1.381394
Jarnell Stokes      0.262660
Tyrus Thomas       -0.043536
Beno Udrih         -1.207587
dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Compare-to-ESPN's-RPM">Compare to ESPN's RPM<a class="anchor-link" href="#Compare-to-ESPN's-RPM">&#182;</a></h3><p>We can compare our results ESPN's Real Plus/Minus statistic.</p>
<p>Compared against overall RPM from 2014-15, our rating is actually that not that bad.  We're overrating players a bit and maybe using more years would help.  RPM actually uses box score data and some biographic data to help stabilize the regression further.  We are working purely with lineup data so if they are doing things well, that extra data will improve things for them.</p>
<p>Also note that ESPN produces Offensive RPM and Defensive RPM. To do this, we need to break up the stint data into offense and defense performance and have <em>two</em> effects for each player, one for offense and one for defense.</p>
<p>They also convert RPM to Wins, presumably using something like the pythagorean expectation formula.  Kevin Pelton's WARP statistic does similarly.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[27]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rpm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;rpm.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;RK&#39;</span><span class="p">)</span>
<span class="n">rpm</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[27]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>TEAM</th>
      <th>GP</th>
      <th>MPG</th>
      <th>ORPM</th>
      <th>DRPM</th>
      <th>RPM</th>
      <th>WINS</th>
    </tr>
    <tr>
      <th>RK</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>Stephen Curry, PG</td>
      <td>GS</td>
      <td>80</td>
      <td>32.7</td>
      <td>7.43</td>
      <td>1.91</td>
      <td>9.34</td>
      <td>20.07</td>
    </tr>
    <tr>
      <th>2</th>
      <td>LeBron James, SF</td>
      <td>CLE</td>
      <td>69</td>
      <td>36.1</td>
      <td>6.02</td>
      <td>2.76</td>
      <td>8.78</td>
      <td>17.03</td>
    </tr>
    <tr>
      <th>3</th>
      <td>James Harden, PG</td>
      <td>HOU</td>
      <td>81</td>
      <td>36.8</td>
      <td>8.66</td>
      <td>-0.16</td>
      <td>8.50</td>
      <td>20.63</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Anthony Davis, PF</td>
      <td>NO</td>
      <td>68</td>
      <td>36.1</td>
      <td>3.98</td>
      <td>4.20</td>
      <td>8.18</td>
      <td>15.86</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Kawhi Leonard, SF</td>
      <td>SA</td>
      <td>64</td>
      <td>31.8</td>
      <td>2.98</td>
      <td>4.59</td>
      <td>7.57</td>
      <td>12.67</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Russell Westbrook, PG</td>
      <td>OKC</td>
      <td>67</td>
      <td>34.4</td>
      <td>7.79</td>
      <td>-0.71</td>
      <td>7.08</td>
      <td>14.15</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Chris Paul, PG</td>
      <td>LAC</td>
      <td>82</td>
      <td>34.8</td>
      <td>6.45</td>
      <td>0.47</td>
      <td>6.92</td>
      <td>16.75</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Draymond Green, PF</td>
      <td>GS</td>
      <td>79</td>
      <td>31.5</td>
      <td>1.57</td>
      <td>5.23</td>
      <td>6.80</td>
      <td>14.80</td>
    </tr>
    <tr>
      <th>9</th>
      <td>DeMarcus Cousins, C</td>
      <td>SAC</td>
      <td>59</td>
      <td>34.1</td>
      <td>1.41</td>
      <td>4.71</td>
      <td>6.12</td>
      <td>10.86</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Khris Middleton, SF</td>
      <td>MIL</td>
      <td>79</td>
      <td>30.1</td>
      <td>1.97</td>
      <td>4.09</td>
      <td>6.06</td>
      <td>12.42</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Kyle Korver, SG</td>
      <td>ATL</td>
      <td>75</td>
      <td>32.2</td>
      <td>4.08</td>
      <td>1.34</td>
      <td>5.42</td>
      <td>11.59</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Danny Green, SG</td>
      <td>SA</td>
      <td>81</td>
      <td>28.5</td>
      <td>3.25</td>
      <td>2.16</td>
      <td>5.41</td>
      <td>11.00</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Tim Duncan, C</td>
      <td>SA</td>
      <td>77</td>
      <td>28.9</td>
      <td>0.53</td>
      <td>4.67</td>
      <td>5.20</td>
      <td>10.33</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Paul Millsap, PF</td>
      <td>ATL</td>
      <td>73</td>
      <td>32.7</td>
      <td>2.87</td>
      <td>2.22</td>
      <td>5.09</td>
      <td>11.01</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Tony Allen, SG</td>
      <td>MEM</td>
      <td>63</td>
      <td>26.2</td>
      <td>-0.11</td>
      <td>4.92</td>
      <td>4.81</td>
      <td>7.23</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Zaza Pachulia, C</td>
      <td>MIL</td>
      <td>73</td>
      <td>23.7</td>
      <td>1.38</td>
      <td>3.42</td>
      <td>4.80</td>
      <td>7.66</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Tyson Chandler, C</td>
      <td>DAL</td>
      <td>75</td>
      <td>30.5</td>
      <td>1.04</td>
      <td>3.54</td>
      <td>4.58</td>
      <td>9.99</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Zach Randolph, PF</td>
      <td>MEM</td>
      <td>71</td>
      <td>32.5</td>
      <td>1.84</td>
      <td>2.71</td>
      <td>4.55</td>
      <td>9.58</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Gordon Hayward, SF</td>
      <td>UTAH</td>
      <td>76</td>
      <td>34.4</td>
      <td>3.30</td>
      <td>1.19</td>
      <td>4.49</td>
      <td>10.81</td>
    </tr>
    <tr>
      <th>20</th>
      <td>DeAndre Jordan, C</td>
      <td>LAC</td>
      <td>82</td>
      <td>34.4</td>
      <td>2.03</td>
      <td>2.43</td>
      <td>4.46</td>
      <td>12.08</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Cody Zeller, C</td>
      <td>CHA</td>
      <td>62</td>
      <td>24.0</td>
      <td>1.12</td>
      <td>3.23</td>
      <td>4.35</td>
      <td>6.08</td>
    </tr>
    <tr>
      <th>22</th>
      <td>John Wall, PG</td>
      <td>WSH</td>
      <td>79</td>
      <td>35.9</td>
      <td>2.57</td>
      <td>1.73</td>
      <td>4.30</td>
      <td>11.63</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Jimmy Butler, SG</td>
      <td>CHI</td>
      <td>65</td>
      <td>38.7</td>
      <td>3.87</td>
      <td>0.43</td>
      <td>4.30</td>
      <td>10.31</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Kevin Durant, SF</td>
      <td>OKC</td>
      <td>27</td>
      <td>33.8</td>
      <td>3.53</td>
      <td>0.67</td>
      <td>4.20</td>
      <td>3.87</td>
    </tr>
    <tr>
      <th>25</th>
      <td>LaMarcus Aldridge, PF</td>
      <td>POR</td>
      <td>71</td>
      <td>35.4</td>
      <td>3.70</td>
      <td>0.36</td>
      <td>4.06</td>
      <td>9.95</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Kyle Lowry, PG</td>
      <td>TOR</td>
      <td>70</td>
      <td>34.5</td>
      <td>2.58</td>
      <td>1.25</td>
      <td>3.83</td>
      <td>9.28</td>
    </tr>
    <tr>
      <th>27</th>
      <td>George Hill, PG</td>
      <td>IND</td>
      <td>43</td>
      <td>29.5</td>
      <td>4.64</td>
      <td>-0.87</td>
      <td>3.77</td>
      <td>4.76</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Damian Lillard, PG</td>
      <td>POR</td>
      <td>82</td>
      <td>35.7</td>
      <td>4.14</td>
      <td>-0.37</td>
      <td>3.77</td>
      <td>11.15</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Wesley Matthews, SG</td>
      <td>POR</td>
      <td>60</td>
      <td>33.7</td>
      <td>1.38</td>
      <td>2.27</td>
      <td>3.65</td>
      <td>7.55</td>
    </tr>
    <tr>
      <th>30</th>
      <td>Klay Thompson, SG</td>
      <td>GS</td>
      <td>77</td>
      <td>31.9</td>
      <td>4.36</td>
      <td>-0.72</td>
      <td>3.64</td>
      <td>9.60</td>
    </tr>
    <tr>
      <th>31</th>
      <td>Marc Gasol, C</td>
      <td>MEM</td>
      <td>81</td>
      <td>33.2</td>
      <td>1.70</td>
      <td>1.91</td>
      <td>3.61</td>
      <td>9.68</td>
    </tr>
    <tr>
      <th>32</th>
      <td>Nikola Mirotic, PF</td>
      <td>CHI</td>
      <td>82</td>
      <td>20.2</td>
      <td>1.75</td>
      <td>1.75</td>
      <td>3.50</td>
      <td>5.92</td>
    </tr>
    <tr>
      <th>33</th>
      <td>Kelly Olynyk, PF</td>
      <td>BOS</td>
      <td>64</td>
      <td>22.3</td>
      <td>1.79</td>
      <td>1.71</td>
      <td>3.50</td>
      <td>5.27</td>
    </tr>
    <tr>
      <th>34</th>
      <td>Serge Ibaka, PF</td>
      <td>OKC</td>
      <td>64</td>
      <td>33.1</td>
      <td>-0.05</td>
      <td>3.51</td>
      <td>3.46</td>
      <td>7.75</td>
    </tr>
    <tr>
      <th>35</th>
      <td>Eric Bledsoe, PG</td>
      <td>PHX</td>
      <td>81</td>
      <td>34.6</td>
      <td>1.61</td>
      <td>1.85</td>
      <td>3.46</td>
      <td>10.38</td>
    </tr>
    <tr>
      <th>36</th>
      <td>Markieff Morris, PF</td>
      <td>PHX</td>
      <td>82</td>
      <td>31.5</td>
      <td>0.40</td>
      <td>3.03</td>
      <td>3.43</td>
      <td>9.49</td>
    </tr>
    <tr>
      <th>37</th>
      <td>Derrick Favors, PF</td>
      <td>UTAH</td>
      <td>74</td>
      <td>30.8</td>
      <td>1.22</td>
      <td>2.18</td>
      <td>3.40</td>
      <td>7.84</td>
    </tr>
    <tr>
      <th>38</th>
      <td>Kyrie Irving, PG</td>
      <td>CLE</td>
      <td>75</td>
      <td>36.4</td>
      <td>4.29</td>
      <td>-0.89</td>
      <td>3.40</td>
      <td>9.74</td>
    </tr>
    <tr>
      <th>39</th>
      <td>Luol Deng, SF</td>
      <td>MIA</td>
      <td>72</td>
      <td>33.6</td>
      <td>3.70</td>
      <td>-0.33</td>
      <td>3.37</td>
      <td>8.41</td>
    </tr>
    <tr>
      <th>40</th>
      <td>Blake Griffin, PF</td>
      <td>LAC</td>
      <td>67</td>
      <td>35.2</td>
      <td>2.97</td>
      <td>0.38</td>
      <td>3.35</td>
      <td>8.46</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </body>
  
 


</html>
