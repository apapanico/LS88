<!DOCTYPE html>
<html>
  <head><meta charset="utf-8" />
    
    <title></title><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

    

    <!-- Custom stylesheet, it must be in the same directory as the html file -->
    <link rel="stylesheet" href="../../assets/css/notebook.css">

  <!-- Loading mathjax macro -->
    <!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    <!-- End of mathjax configuration --></head>

    

    <body>
      <div tabindex="-1" id="notebook" class="border-box-sizing">
        <div class="container" id="notebook-container">
    
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Demo---RE24">Demo - RE24<a class="anchor-link" href="#Demo---RE24">&#182;</a></h1><p>In this demo, we use run expectancy to create a valuation of hitting events that occur known as <em>RE24</em>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">run</span> ../../utils/notebook_setup.py
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Adding datascience helper tools to path...
Setting up Matplotlib...
Matplotlib imported as mpl
Matplotlib.pyplot imported as plt
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">datascience</span> <span class="k">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">datascience.util</span> <span class="k">import</span> <span class="n">table_apply</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># custom functions that will help do some simple tasks</span>
<span class="kn">from</span> <span class="nn">datascience_utils</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">datascience_stats</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">datascience_topic</span> <span class="k">import</span> <span class="n">fast_run_expectancy</span><span class="p">,</span> <span class="n">most_common_lineup_position</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="RE24">RE24<a class="anchor-link" href="#RE24">&#182;</a></h2><p>The RE24 run production values for each plate appearance is computed as
$$
    \mathit{RE24} = \text{Run Expectancy}_{\text{Next}} - \text{Run Expectancy}_{\text{Current}} + \text{Runs Scored}
$$</p>
<p>We will use the retrosheet dataset we uses for the run expectancy demo and we will use the Run Expectancy Matrix from that demo as well.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-Play-by-Play-Data-from-Retrosheet">Load Play-by-Play Data from Retrosheet<a class="anchor-link" href="#Load-Play-by-Play-Data-from-Retrosheet">&#182;</a></h3><p>Raw Retrosheet data (<a href="http://www.retrosheet.org/">http://www.retrosheet.org/</a>) contains play-by-play event logs, representing very raw information about the events in a baseball game. Lucky for us, the software program Chadwick (found here:<a href="http://chadwick.sourceforge.net/doc/index.html">http://chadwick.sourceforge.net/doc/index.html</a>) was created to handle a lot of the messy work to compiled the data into a useable form.  Chadwick converts the raw logs into CSV which is what we use here.  Also, Chadwick computes some pretty important quantities that we make use of.</p>
<p>Note: This notebook uses data from 2001.  We could have used more recent data but Barry Bonds is a baseball god so part of this notebook is an excuse to revel in his statistical absurdity.</p>
<p>For computing the Run Expectancy Matrix as well as other analsis, we only need a few columns.  The relevant columns are:</p>
<ul>
<li>EVENT_ID - An ID for the event in the dataset</li>
<li>INN_CT - Inning number</li>
<li>EVENT_CD - A code for what happened in the event</li>
<li>OUTS_CT - Number of outs</li>
<li>BAT_LINEUP_ID - Place in the batting order.  1 through 9.</li>
<li>BAT_EVENT_FL - A T/F flag as to whether the play-by-play event corresponds to a plate appearance (T) or some other type of event (F).</li>
<li>START_BASES_CD - An integer code representing the state of the runners, eg. runner on 2nd</li>
<li>END_BASES_CD - An integer code representing the state of the runners AFTER the event ends.</li>
<li>EVENT_OUTS_CT - Number of outs recorded on this event</li>
<li>EVENT_RUNS_CT - Number of runs scored on this event</li>
<li>FATE_RUNS_CT - Number of runs scored AFTER this event</li>
</ul>
<p>We also make some modifications to the table.  See the demo on Run Expectancy for more information on these modifications.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EVENT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;INN_CT&#39;</span><span class="p">,</span> <span class="s1">&#39;EVENT_CD&#39;</span><span class="p">,</span> <span class="s1">&#39;OUTS_CT&#39;</span><span class="p">,</span> <span class="s1">&#39;BAT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;BAT_LINEUP_ID&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BAT_EVENT_FL&#39;</span><span class="p">,</span> <span class="s1">&#39;START_BASES_CD&#39;</span><span class="p">,</span> <span class="s1">&#39;END_BASES_CD&#39;</span><span class="p">,</span> <span class="s1">&#39;EVENT_OUTS_CT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;EVENT_RUNS_CT&#39;</span><span class="p">,</span> <span class="s1">&#39;FATE_RUNS_CT&#39;</span><span class="p">]</span>
<span class="n">retro</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s1">&#39;retrosheet_events-2001.csv.gz&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

<span class="n">new_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Inning&#39;</span><span class="p">,</span> <span class="s1">&#39;Event_Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Outs&#39;</span><span class="p">,</span> <span class="s1">&#39;Batter_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Lineup_Order&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PA_Flag&#39;</span><span class="p">,</span> <span class="s1">&#39;Start_Bases&#39;</span><span class="p">,</span> <span class="s1">&#39;End_Bases&#39;</span><span class="p">,</span> <span class="s1">&#39;Event_Outs&#39;</span><span class="p">,</span> <span class="s1">&#39;Event_Runs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Future_Runs&#39;</span><span class="p">]</span>
<span class="n">retro</span><span class="o">.</span><span class="n">relabel</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">new_cols</span><span class="p">)</span>

<span class="n">bat_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">retro</span><span class="p">[</span><span class="s1">&#39;PA_Flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">)</span>
<span class="n">retro</span> <span class="o">=</span> <span class="n">retro</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bat_mask</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">inning_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">retro</span><span class="p">[</span><span class="s1">&#39;Inning&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">retro</span> <span class="o">=</span> <span class="n">retro</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inning_mask</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">base_runner_codes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;None on&quot;</span><span class="p">,</span>  <span class="c1"># No one on</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;1st&quot;</span><span class="p">,</span>  <span class="c1"># runner on 1st</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;2nd&quot;</span><span class="p">,</span>  <span class="c1"># runner on 2nd</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;1st and 2nd&quot;</span><span class="p">,</span>  <span class="c1"># runners on 1st &amp; 2nd</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;3rd&quot;</span><span class="p">,</span>  <span class="c1"># runner on 3rd</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;1st and 3rd&quot;</span><span class="p">,</span>  <span class="c1"># runners on 1st &amp; 3rd</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;2nd and 3rd&quot;</span><span class="p">,</span>  <span class="c1"># runners on 2nd &amp; 3rd</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s2">&quot;Bases Loaded&quot;</span>  <span class="c1"># bases loaded</span>
<span class="p">}</span>
<span class="c1"># Replace the numeric code with a string code</span>
<span class="n">retro</span><span class="p">[</span><span class="s1">&#39;Start_Bases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">retro</span><span class="p">,</span> <span class="s1">&#39;Start_Bases&#39;</span><span class="p">,</span> <span class="n">base_runner_codes</span><span class="p">)</span>
<span class="n">retro</span><span class="p">[</span><span class="s1">&#39;End_Bases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">retro</span><span class="p">,</span> <span class="s1">&#39;End_Bases&#39;</span><span class="p">,</span> <span class="n">base_runner_codes</span><span class="p">)</span>

<span class="n">event_codes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;Generic out&#39;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span>  <span class="c1"># Strikeout</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;SB&#39;</span><span class="p">,</span>  <span class="c1"># Stolen Base</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;Defensive indifference&#39;</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;CS&#39;</span><span class="p">,</span>  <span class="c1"># Caught stealing</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;Pickoff error&#39;</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;Pickoff&#39;</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;Wild pitch&#39;</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;Passed ball&#39;</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;Balk&#39;</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;Other advance/out advancing&#39;</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">:</span> <span class="s1">&#39;Foul error&#39;</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">:</span> <span class="s1">&#39;BB&#39;</span><span class="p">,</span>  <span class="c1"># Walk</span>
    <span class="mi">15</span><span class="p">:</span> <span class="s1">&#39;IBB&#39;</span><span class="p">,</span>  <span class="c1"># Intentional walk</span>
    <span class="mi">16</span><span class="p">:</span> <span class="s1">&#39;HBP&#39;</span><span class="p">,</span>  <span class="c1"># Hit by pitch</span>
    <span class="mi">17</span><span class="p">:</span> <span class="s1">&#39;Interference&#39;</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">:</span> <span class="s1">&#39;RBOE&#39;</span><span class="p">,</span>  <span class="c1"># Reached base on error</span>
    <span class="mi">19</span><span class="p">:</span> <span class="s1">&#39;FC&#39;</span><span class="p">,</span>  <span class="c1"># Fielder&#39;s choice</span>
    <span class="mi">20</span><span class="p">:</span> <span class="s1">&#39;1B&#39;</span><span class="p">,</span>  <span class="c1"># Single</span>
    <span class="mi">21</span><span class="p">:</span> <span class="s1">&#39;2B&#39;</span><span class="p">,</span>  <span class="c1"># Double</span>
    <span class="mi">22</span><span class="p">:</span> <span class="s1">&#39;3B&#39;</span><span class="p">,</span>  <span class="c1"># Triple</span>
    <span class="mi">23</span><span class="p">:</span> <span class="s1">&#39;HR&#39;</span><span class="p">,</span>  <span class="c1"># Home run</span>
    <span class="mi">24</span><span class="p">:</span> <span class="s1">&#39;Missing play&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Replace numeric code with string</span>
<span class="n">retro</span><span class="p">[</span><span class="s1">&#39;Event_Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">retro</span><span class="p">,</span> <span class="s1">&#39;Event_Type&#39;</span><span class="p">,</span> <span class="n">event_codes</span><span class="p">)</span>

<span class="n">retro</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>Inning</th> <th>Outs</th> <th>Batter_ID</th> <th>Lineup_Order</th> <th>Event_Type</th> <th>PA_Flag</th> <th>Event_Outs</th> <th>ID</th> <th>Start_Bases</th> <th>End_Bases</th> <th>Event_Runs</th> <th>Future_Runs</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1     </td> <td>0   </td> <td>greer001 </td> <td>1           </td> <td>Generic out</td> <td>T      </td> <td>1         </td> <td>1   </td> <td>None on    </td> <td>None on    </td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>1   </td> <td>velar001 </td> <td>2           </td> <td>Generic out</td> <td>T      </td> <td>1         </td> <td>2   </td> <td>None on    </td> <td>None on    </td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>2   </td> <td>rodra001 </td> <td>3           </td> <td>Generic out</td> <td>T      </td> <td>1         </td> <td>3   </td> <td>None on    </td> <td>None on    </td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>0   </td> <td>erstd001 </td> <td>1           </td> <td>1B         </td> <td>T      </td> <td>0         </td> <td>4   </td> <td>None on    </td> <td>1st        </td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>0   </td> <td>ecksd001 </td> <td>2           </td> <td>1B         </td> <td>T      </td> <td>0         </td> <td>5   </td> <td>1st        </td> <td>1st and 2nd</td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>0   </td> <td>salmt001 </td> <td>3           </td> <td>K          </td> <td>T      </td> <td>2         </td> <td>6   </td> <td>1st and 2nd</td> <td>3rd        </td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>2   </td> <td>glaut001 </td> <td>4           </td> <td>BB         </td> <td>T      </td> <td>0         </td> <td>7   </td> <td>3rd        </td> <td>1st and 3rd</td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>1     </td> <td>2   </td> <td>andeg001 </td> <td>5           </td> <td>Generic out</td> <td>T      </td> <td>1         </td> <td>8   </td> <td>1st and 3rd</td> <td>1st and 3rd</td> <td>0         </td> <td>0          </td>
        </tr>
    </tbody>
        <tr>
            <td>2     </td> <td>0   </td> <td>palmr001 </td> <td>4           </td> <td>BB         </td> <td>T      </td> <td>0         </td> <td>9   </td> <td>None on    </td> <td>1st        </td> <td>0         </td> <td>4          </td>
        </tr>
    </tbody>
        <tr>
            <td>2     </td> <td>0   </td> <td>rodri001 </td> <td>5           </td> <td>Generic out</td> <td>T      </td> <td>1         </td> <td>10  </td> <td>1st        </td> <td>1st        </td> <td>0         </td> <td>4          </td>
        </tr>
    </tbody>
</table>
<p>... (167876 rows omitted)</p
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Load-Run-Expectancy-Matrix">Load Run Expectancy Matrix<a class="anchor-link" href="#Load-Run-Expectancy-Matrix">&#182;</a></h3><p>We computed the Run Expectancy Matrix in the run expectancy demo so we load it and use it here.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">re</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s1">&#39;re_2001.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Run-Expectancies">Run Expectancies<a class="anchor-link" href="#Run-Expectancies">&#182;</a></h3><p>For each plate appearance, we need to compute the run expectancy that will serve as the backbone for computing the RE24 values.  To do this, we iterate through each PA, get its values for <code>Outs</code> and <code>Start_Bases</code> and extract the value from the Run Expectancy Matrix we computed earlier.  We do the same for the future state using <code>End_Bases</code> and <code>Outs + Event_Outs</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># NOTE: THIS CELL IS SLOW.</span>
<span class="c1"># It&#39;s easier to understand what the calculation is with this block of code but</span>
<span class="c1"># after that, you might as well run the next cell.</span>

<span class="c1"># # Iterate through PAs computing run expectancy</span>
<span class="c1"># run_exp = np.array([</span>
<span class="c1">#     re.where(&#39;Outs&#39;, outs).\</span>
<span class="c1">#         where(&#39;Start_Bases&#39;, base)[&#39;RE&#39;].\</span>
<span class="c1">#         item() if outs &lt; 3 else 0</span>
<span class="c1">#     for outs, base in zip(retro[&#39;Outs&#39;], retro[&#39;Start_Bases&#39;])</span>
<span class="c1"># ])</span>
<span class="c1"># retro[&#39;Run_Expectancy&#39;] = run_exp</span>

<span class="c1"># # Iterate through PAs computing run expectancy for next PA</span>
<span class="c1"># next_outs = retro[&#39;Outs&#39;] + retro[&#39;Event_Outs&#39;]</span>
<span class="c1"># next_run_exp = np.array([</span>
<span class="c1">#     re.where(&#39;Outs&#39;, outs).\</span>
<span class="c1">#         where(&#39;Start_Bases&#39;, base)[&#39;RE&#39;].\</span>
<span class="c1">#         item() if outs &lt; 3 else 0</span>
<span class="c1">#     for outs, base in zip(next_outs, retro[&#39;End_Bases&#39;])</span>
<span class="c1"># ])</span>
<span class="c1"># retro[&#39;Run_Expectancy_Next&#39;] = next_run_exp</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># This only takes about a second or two</span>
<span class="n">retro</span> <span class="o">=</span> <span class="n">fast_run_expectancy</span><span class="p">(</span><span class="n">retro</span><span class="p">,</span> <span class="n">re</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">view_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Batter_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Lineup_Order&#39;</span><span class="p">,</span> <span class="s1">&#39;Inning&#39;</span><span class="p">,</span> <span class="s1">&#39;Outs&#39;</span><span class="p">,</span> <span class="s1">&#39;Event_Type&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Start_Bases&#39;</span><span class="p">,</span> <span class="s1">&#39;End_Bases&#39;</span><span class="p">,</span> <span class="s1">&#39;Event_Runs&#39;</span><span class="p">,</span> <span class="s1">&#39;Run_Expectancy&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Run_Expectancy_Next&#39;</span><span class="p">]</span>
<span class="n">retro</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">view_cols</span><span class="p">])</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>Batter_ID</th> <th>Lineup_Order</th> <th>Inning</th> <th>Outs</th> <th>Event_Type</th> <th>Start_Bases</th> <th>End_Bases</th> <th>Event_Runs</th> <th>Run_Expectancy</th> <th>Run_Expectancy_Next</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>greer001 </td> <td>1           </td> <td>1     </td> <td>0   </td> <td>Generic out</td> <td>None on    </td> <td>None on    </td> <td>0         </td> <td>0.544516      </td> <td>0.291897           </td>
        </tr>
    </tbody>
        <tr>
            <td>velar001 </td> <td>2           </td> <td>1     </td> <td>1   </td> <td>Generic out</td> <td>None on    </td> <td>None on    </td> <td>0         </td> <td>0.291897      </td> <td>0.118223           </td>
        </tr>
    </tbody>
        <tr>
            <td>rodra001 </td> <td>3           </td> <td>1     </td> <td>2   </td> <td>Generic out</td> <td>None on    </td> <td>None on    </td> <td>0         </td> <td>0.118223      </td> <td>0                  </td>
        </tr>
    </tbody>
        <tr>
            <td>erstd001 </td> <td>1           </td> <td>1     </td> <td>0   </td> <td>1B         </td> <td>None on    </td> <td>1st        </td> <td>0         </td> <td>0.544516      </td> <td>0.93984            </td>
        </tr>
    </tbody>
        <tr>
            <td>ecksd001 </td> <td>2           </td> <td>1     </td> <td>0   </td> <td>1B         </td> <td>1st        </td> <td>1st and 2nd</td> <td>0         </td> <td>0.93984       </td> <td>1.55191            </td>
        </tr>
    </tbody>
</table>
<p>... (167881 rows omitted)</p
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Compute-RE24">Compute RE24<a class="anchor-link" href="#Compute-RE24">&#182;</a></h3><p>Now its easy to compute the RE24 values using the fields we have computed.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">retro</span><span class="p">[</span><span class="s1">&#39;RE24&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">retro</span><span class="p">[</span><span class="s1">&#39;Run_Expectancy_Next&#39;</span><span class="p">]</span> <span class="o">-</span> \
    <span class="n">retro</span><span class="p">[</span><span class="s1">&#39;Run_Expectancy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">retro</span><span class="p">[</span><span class="s1">&#39;Event_Runs&#39;</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Example">Example<a class="anchor-link" href="#Example">&#182;</a></h4><p>Here are the first 10 rows from the Retrosheet table showing the first inning plus a bit of the second inning of the first game between the Angels and the Rangers.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">retro</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">view_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;RE24&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>Batter_ID</th> <th>Lineup_Order</th> <th>Inning</th> <th>Outs</th> <th>Event_Type</th> <th>Start_Bases</th> <th>End_Bases</th> <th>Event_Runs</th> <th>Run_Expectancy</th> <th>Run_Expectancy_Next</th> <th>RE24</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>greer001 </td> <td>1           </td> <td>1     </td> <td>0   </td> <td>Generic out</td> <td>None on    </td> <td>None on    </td> <td>0         </td> <td>0.544516      </td> <td>0.291897           </td> <td>-0.252619</td>
        </tr>
    </tbody>
        <tr>
            <td>velar001 </td> <td>2           </td> <td>1     </td> <td>1   </td> <td>Generic out</td> <td>None on    </td> <td>None on    </td> <td>0         </td> <td>0.291897      </td> <td>0.118223           </td> <td>-0.173674</td>
        </tr>
    </tbody>
        <tr>
            <td>rodra001 </td> <td>3           </td> <td>1     </td> <td>2   </td> <td>Generic out</td> <td>None on    </td> <td>None on    </td> <td>0         </td> <td>0.118223      </td> <td>0                  </td> <td>-0.118223</td>
        </tr>
    </tbody>
        <tr>
            <td>erstd001 </td> <td>1           </td> <td>1     </td> <td>0   </td> <td>1B         </td> <td>None on    </td> <td>1st        </td> <td>0         </td> <td>0.544516      </td> <td>0.93984            </td> <td>0.395324 </td>
        </tr>
    </tbody>
        <tr>
            <td>ecksd001 </td> <td>2           </td> <td>1     </td> <td>0   </td> <td>1B         </td> <td>1st        </td> <td>1st and 2nd</td> <td>0         </td> <td>0.93984       </td> <td>1.55191            </td> <td>0.612075 </td>
        </tr>
    </tbody>
        <tr>
            <td>salmt001 </td> <td>3           </td> <td>1     </td> <td>0   </td> <td>K          </td> <td>1st and 2nd</td> <td>3rd        </td> <td>0         </td> <td>1.55191       </td> <td>0.36757            </td> <td>-1.18435 </td>
        </tr>
    </tbody>
        <tr>
            <td>glaut001 </td> <td>4           </td> <td>1     </td> <td>2   </td> <td>BB         </td> <td>3rd        </td> <td>1st and 3rd</td> <td>0         </td> <td>0.36757       </td> <td>0.508051           </td> <td>0.140481 </td>
        </tr>
    </tbody>
        <tr>
            <td>andeg001 </td> <td>5           </td> <td>1     </td> <td>2   </td> <td>Generic out</td> <td>1st and 3rd</td> <td>1st and 3rd</td> <td>0         </td> <td>0.508051      </td> <td>0                  </td> <td>-0.508051</td>
        </tr>
    </tbody>
        <tr>
            <td>palmr001 </td> <td>4           </td> <td>2     </td> <td>0   </td> <td>BB         </td> <td>None on    </td> <td>1st        </td> <td>0         </td> <td>0.544516      </td> <td>0.93984            </td> <td>0.395324 </td>
        </tr>
    </tbody>
        <tr>
            <td>rodri001 </td> <td>5           </td> <td>2     </td> <td>0   </td> <td>Generic out</td> <td>1st        </td> <td>1st        </td> <td>0         </td> <td>0.93984       </td> <td>0.56               </td> <td>-0.37984 </td>
        </tr>
    </tbody>
</table>
<p>... (167876 rows omitted)</p
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Grand-Slams">Grand Slams<a class="anchor-link" href="#Grand-Slams">&#182;</a></h4><p>Below are three grand slams hit by Carl Everett, Barry Bonds, and Doug Mirabelli with different out situations.</p>
<p>First, notice how the high run expectancy at the beginning of the at-bat leads to a reduced or "discounted" RE24 value that does not equal 4.</p>
<p>Second, notice how the circumstances of the outs lead to receiving different values for the grand slam.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">retro</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">view_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;RE24&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">23080</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[10]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>Batter_ID</th> <th>Lineup_Order</th> <th>Inning</th> <th>Outs</th> <th>Event_Type</th> <th>Start_Bases</th> <th>End_Bases</th> <th>Event_Runs</th> <th>Run_Expectancy</th> <th>Run_Expectancy_Next</th> <th>RE24</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>everc001 </td> <td>3           </td> <td>6     </td> <td>0   </td> <td>HR        </td> <td>Bases Loaded</td> <td>None on  </td> <td>4         </td> <td>2.39332       </td> <td>0.544516           </td> <td>2.15119</td>
        </tr>
    </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">retro</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">view_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;RE24&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">9090</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[11]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>Batter_ID</th> <th>Lineup_Order</th> <th>Inning</th> <th>Outs</th> <th>Event_Type</th> <th>Start_Bases</th> <th>End_Bases</th> <th>Event_Runs</th> <th>Run_Expectancy</th> <th>Run_Expectancy_Next</th> <th>RE24</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>bondb001 </td> <td>3           </td> <td>5     </td> <td>1   </td> <td>HR        </td> <td>Bases Loaded</td> <td>None on  </td> <td>4         </td> <td>1.60661       </td> <td>0.291897           </td> <td>2.68529</td>
        </tr>
    </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">retro</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">view_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;RE24&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">4097</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[12]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>Batter_ID</th> <th>Lineup_Order</th> <th>Inning</th> <th>Outs</th> <th>Event_Type</th> <th>Start_Bases</th> <th>End_Bases</th> <th>Event_Runs</th> <th>Run_Expectancy</th> <th>Run_Expectancy_Next</th> <th>RE24</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>mirad001 </td> <td>9           </td> <td>3     </td> <td>2   </td> <td>HR        </td> <td>Bases Loaded</td> <td>None on  </td> <td>4         </td> <td>0.792754      </td> <td>0.118223           </td> <td>3.32547</td>
        </tr>
    </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Ichiro-Going-1st-to-3rd">Ichiro Going 1st to 3rd<a class="anchor-link" href="#Ichiro-Going-1st-to-3rd">&#182;</a></h4><p>A good baserunner like Ichiro (led the league in 2001 with 56 SB) that can get from 1st to 3rd on a hit easier can make the next hitter look better.</p>
<p>The following two pairs of events have Ichiro reaching 1st with no outs.  Compare the RE24 values of these two outcomes for the subsequent batters.  The events are identical except for Ichiro going to 3rd instead of 2nd on the single.  While the hitters are different (Mike Cameron vs Mark Mclemore) and we know little about the nature of the single that was hit, this shows a variation in values of RE24 for seemingly equal events.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">retro</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">view_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;RE24&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">take</span><span class="p">[[</span><span class="mi">112064</span><span class="p">,</span> <span class="mi">112065</span><span class="p">]]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[13]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>Batter_ID</th> <th>Lineup_Order</th> <th>Inning</th> <th>Outs</th> <th>Event_Type</th> <th>Start_Bases</th> <th>End_Bases</th> <th>Event_Runs</th> <th>Run_Expectancy</th> <th>Run_Expectancy_Next</th> <th>RE24</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>suzui001 </td> <td>1           </td> <td>3     </td> <td>0   </td> <td>1B        </td> <td>None on    </td> <td>1st        </td> <td>0         </td> <td>0.544516      </td> <td>0.93984            </td> <td>0.395324</td>
        </tr>
    </tbody>
        <tr>
            <td>camem001 </td> <td>2           </td> <td>3     </td> <td>0   </td> <td>1B        </td> <td>1st        </td> <td>1st and 2nd</td> <td>0         </td> <td>0.93984       </td> <td>1.55191            </td> <td>0.612075</td>
        </tr>
    </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">retro</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">view_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;RE24&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">take</span><span class="p">[[</span><span class="mi">26273</span><span class="p">,</span> <span class="mi">26274</span><span class="p">]]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[14]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>Batter_ID</th> <th>Lineup_Order</th> <th>Inning</th> <th>Outs</th> <th>Event_Type</th> <th>Start_Bases</th> <th>End_Bases</th> <th>Event_Runs</th> <th>Run_Expectancy</th> <th>Run_Expectancy_Next</th> <th>RE24</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>suzui001 </td> <td>1           </td> <td>5     </td> <td>0   </td> <td>1B        </td> <td>None on    </td> <td>1st        </td> <td>0         </td> <td>0.544516      </td> <td>0.93984            </td> <td>0.395324</td>
        </tr>
    </tbody>
        <tr>
            <td>mclem001 </td> <td>2           </td> <td>5     </td> <td>0   </td> <td>1B        </td> <td>1st        </td> <td>1st and 3rd</td> <td>0         </td> <td>0.93984       </td> <td>1.86905            </td> <td>0.929208</td>
        </tr>
    </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>Question</em></p>
<ol>
<li>The underlying assumption of this approach is that the hitter receives all credit for everything on the basepaths.  Alternatively, we could ascribe all baserunning credit to the baserunner.  How might we adjust the RE24 computation to give Ichiro full credit for moving from second to third?  Does your computation apply more broadly to other situations?  What sort of information would we need?</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Batter-RE24">Batter RE24<a class="anchor-link" href="#Batter-RE24">&#182;</a></h3><p>We can group on <code>Batter_ID</code> and compute the Total RE24 for each batter.  We do this by just summing.</p>
<p>We don't have much context for how this statistic should behave since we only have one year and only view the top 10.  This can be done by diving into the statistic more on Baseball Reference or FanGraphs.  That said, it should be noted that (depending on how the statistic is ultimately computed and adjusted for various considerations), Barry Bonds' 2001, 2002, and 2004 seasons were absolutely obscene when it comes to offense and run production by any and all metrics.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">batter_data</span> <span class="o">=</span> <span class="n">retro</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;Batter_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Run_Expectancy&#39;</span><span class="p">,</span> <span class="s1">&#39;RE24&#39;</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">group</span><span class="p">(</span><span class="s1">&#39;Batter_ID&#39;</span><span class="p">,</span> <span class="n">collect</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
<span class="n">batter_data</span><span class="o">.</span><span class="n">relabel</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;Run_Expectancy sum&#39;</span><span class="p">,</span> <span class="s1">&#39;RE24 sum&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Run_Expectancy&#39;</span><span class="p">,</span> <span class="s1">&#39;RE24&#39;</span><span class="p">])</span>
<span class="n">batter_data</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;RE24&#39;</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>Batter_ID</th> <th>Run_Expectancy</th> <th>RE24</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>bondb001 </td> <td>300.874       </td> <td>105.56 </td>
        </tr>
    </tbody>
        <tr>
            <td>sosas001 </td> <td>361.867       </td> <td>82.1114</td>
        </tr>
    </tbody>
        <tr>
            <td>giamj001 </td> <td>324.731       </td> <td>76.0535</td>
        </tr>
    </tbody>
        <tr>
            <td>heltt001 </td> <td>342.564       </td> <td>71.9047</td>
        </tr>
    </tbody>
        <tr>
            <td>gonzl001 </td> <td>338.671       </td> <td>67.2304</td>
        </tr>
    </tbody>
        <tr>
            <td>berkl001 </td> <td>345.674       </td> <td>65.8272</td>
        </tr>
    </tbody>
        <tr>
            <td>bagwj001 </td> <td>347.962       </td> <td>59.313 </td>
        </tr>
    </tbody>
        <tr>
            <td>walkl001 </td> <td>288.935       </td> <td>55.8702</td>
        </tr>
    </tbody>
        <tr>
            <td>edmoj001 </td> <td>292.994       </td> <td>55.1297</td>
        </tr>
    </tbody>
        <tr>
            <td>jonec004 </td> <td>308.537       </td> <td>54.3762</td>
        </tr>
    </tbody>
</table>
<p>... (951 rows omitted)</p
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>Questions</em></p>
<ol>
<li>RE24 credits the batter with the run scored.  What is the assumption underlying this?  When would you want to give credit (or partial credit) to the baserunner?
2 What do you make of two Rockies players appearing on that list in 2001? (heltt001 is Todd Helton and walkl001 is Larry Walker)  What would be your first step in trying to adjust to reflect their favorable park?</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="On-Your-Own:-Run-Potential-and-RE24-for-Batters">On Your Own: Run Potential and RE24 for Batters<a class="anchor-link" href="#On-Your-Own:-Run-Potential-and-RE24-for-Batters">&#182;</a></h3><p>Total RE24 for batters is a pretty cool stat given how we have accounted for run expectancy to try to better value events, especially ones that do not score runs.</p>
<p>But one thing we should wonder is how much run expectancy can vary in the batting order and how this relates to RE24.  Batting order and opportunity is a notorious problem for using RBI as a viable statistic and the analysis below corroborates that.</p>
<p>To do:
The function <code>most_common_lineup_order</code> takes in a Retrosheet dataset and finds the most common lineup position for each batter.  Using the derived most common lineup position for a batter, augment the <code>batter_data</code> in two ways:</p>
<ol>
<li>Compute the total number of PAs for each batter.</li>
<li>Build a column containing two categories, "Qualified" and "Not Qualified", where $\mathit{PA} \geq 400$ means a batter is "Qualified".</li>
<li>Join <code>lineup_pos</code> and <code>batter_data</code> on <code>Batter_ID</code>.</li>
<li>Display Barry Bonds' results by selecting on his Batter ID <code>'bondb001'</code>.</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Helper function to do fast groupby and find the most common </span>
<span class="c1"># lineup position for each batter</span>
<span class="n">lineup_pos</span> <span class="o">=</span> <span class="n">most_common_lineup_position</span><span class="p">(</span><span class="n">retro</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To do:
Generate a scatter plot on RE versus RE24 and color by whether the hitter is Qualified or not (ie. has over 400 PA or not).</p>
<p><em>Questions</em></p>
<ol>
<li>What is the relationship between total number of PAs and Total Run Expectancy?</li>
<li>For qualified hitters, what is the relationship between Total RE and Total RE24?  Why do you think the relationship is the way it appears?  What does it say about run expectancy, the quality of a batter, and the batter's run production?</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Run-Potential-and-RE24-in-the-Batting-Order">Run Potential and RE24 in the Batting Order<a class="anchor-link" href="#Run-Potential-and-RE24-in-the-Batting-Order">&#182;</a></h4><p>Let's use the Retrosheet data to compute total RE and RE24 by place in the batting order.  Here we can try to see the direct effects of how the batting order affects run production.</p>
<p>To do: From the Retrosheet table, derive a new table <code>batting_order_totals</code>.  This table should contain three columns:</p>
<ul>
<li>Lineup_Order</li>
<li>Total Run Expectancy for each position in the lineup</li>
<li>Total RE24 for each position in the lineup</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="An-Odd-Finding...">An Odd Finding...<a class="anchor-link" href="#An-Odd-Finding...">&#182;</a></h5><p>We want to know about the relationships between run expectancy and RE24 depending on the lineup position?</p>
<p>To do:</p>
<ol>
<li>Plot RE and RE24 against the lineup position.</li>
</ol>
<p><em>Question</em></p>
<ol>
<li>Which lineup position has the highest total run potential?  Why?  Which did you expect to have the highest total run potential?</li>
<li>Which lineup position has the highest total run production?  Does this seem right?</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="...Easily-Explained">...Easily Explained<a class="anchor-link" href="#...Easily-Explained">&#182;</a></h5><p>To do:</p>
<ol>
<li>Augment <code>batting_order_totals</code> with total PA for each lineup position.  Plot the lineup position against PA.</li>
</ol>
<p><em>Question</em></p>
<ol>
<li>What obvious result do you see?  Why is this so obvious?  What does it mean about the previous result?</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="Normalize-by-Number-of-PAs">Normalize by Number of PAs<a class="anchor-link" href="#Normalize-by-Number-of-PAs">&#182;</a></h5><p>To do:</p>
<ol>
<li>Augment <code>batting_order_totals</code> with two columns: <code>'RE per PA'</code> and <code>'RE24 per PA'</code>.  These two quantities are self-explanatory.</li>
<li>Plots <code>'RE per PA'</code> and <code>'RE24 per PA'</code> against lineup position.</li>
</ol>
<p><em>Question</em></p>
<ul>
<li>Does lineup position, run expectancy, and run production make sense now?</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="Boxplots-by-Lineup-Position">Boxplots by Lineup Position<a class="anchor-link" href="#Boxplots-by-Lineup-Position">&#182;</a></h5><p>Plotting the average is not ideal so with a bit of extract work and a helper function that leverages the boxplot functionality of Pandas, we can view a boxplot of the run potential and production per plate appearance <em>for each player</em> grouped by lineup order.</p>
<p>You can see Barry Bonds' ridiculous performance in the second plot.  He's the #3 hitter with RE24 per PA of 0.175.  If you dig into the data more you find that Bonds did not have a particularly high run potential: 0.5 runs per PA.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[17]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="s1">&#39;Lineup_Order&#39;</span> <span class="ow">in</span> <span class="n">batter_data</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
    <span class="n">re_per_pa</span> <span class="o">=</span> <span class="n">batter_data</span><span class="p">[</span><span class="s1">&#39;Run_Expectancy&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">batter_data</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">]</span>
    <span class="n">re24_per_pa</span> <span class="o">=</span> <span class="n">batter_data</span><span class="p">[</span><span class="s1">&#39;RE24&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">batter_data</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">]</span>
    <span class="n">batter_data</span> <span class="o">=</span> <span class="n">batter_data</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="s1">&#39;RE per PA&#39;</span><span class="p">,</span> <span class="n">re_per_pa</span><span class="p">,</span>
        <span class="s1">&#39;RE24 per PA&#39;</span><span class="p">,</span> <span class="n">re24_per_pa</span>
    <span class="p">)</span>
    <span class="n">qualified_batters</span> <span class="o">=</span> <span class="n">batter_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;qual&#39;</span><span class="p">,</span> <span class="s1">&#39;Qualified&#39;</span><span class="p">)</span>
    <span class="c1"># boxplot_pd is a helper function to use Pandas-style boxplot visualizations</span>
    <span class="n">boxplots</span><span class="p">(</span><span class="n">qualified_batters</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;RE per PA&#39;</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;Lineup_Order&#39;</span><span class="p">)</span>
    <span class="n">boxplots</span><span class="p">(</span><span class="n">qualified_batters</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;RE24 per PA&#39;</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;Lineup_Order&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[18]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="s1">&#39;Lineup_Order&#39;</span> <span class="ow">in</span> <span class="n">batter_data</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
    <span class="n">qualified_batters</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;RE24 per PA&#39;</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>Question</em></p>
<ul>
<li><p>What's a plausible explanation for why the <em>most productive</em> hitter appears to bat third but the fourth and fifth place hitters bat in the most run rich environments?</p>
</li>
<li><p>We figured out that run potential depends on the batting order.  We saw a relationship that showed total run production is associated with total run potential.  We have two plausible reasons for this: (1) higher run potential inherently drives higher run production, and (2), high run producers are put in high run potential situations.  But have we actually been able to figure out whether run production is measuring an ability rather than being a product of environment?</p>
</li>
</ul>

</div>
</div>
</div>
        </div>
      </div>
    </body>
  
 


</html>
